{
  "id": "pipeline_1765590396059",
  "name": "Game Feature Implementer V2",
  "startTime": "2025-12-13T01:46:36.059Z",
  "stages": [
    {
      "id": "assess_state",
      "name": "Assess Current State",
      "type": "analyzer",
      "description": "Analyzes what exists: design docs, existing code, what's working, what's not.",
      "agent": "game_state_assessor",
      "config": {
        "inputs": [],
        "outputs": []
      },
      "position": {
        "x": 4700,
        "y": 5000
      }
    },
    {
      "id": "setup_client",
      "name": "Setup Game Client",
      "type": "implementer",
      "description": "Creates Phaser.js game client boilerplate if it doesn't exist.",
      "agent": "client_scaffolder",
      "config": {
        "inputs": [
          "assess_state"
        ],
        "outputs": []
      },
      "position": {
        "x": 5050,
        "y": 5000
      }
    },
    {
      "id": "select_feature",
      "name": "Select Next Feature",
      "type": "planner",
      "description": "Picks ONE feature from the priority list that isn't implemented yet.",
      "agent": "feature_selector_v2",
      "config": {
        "inputs": [
          "setup_client"
        ],
        "outputs": []
      },
      "position": {
        "x": 5400,
        "y": 5000
      }
    },
    {
      "id": "extract_requirements",
      "name": "Extract Design Requirements",
      "type": "planner",
      "description": "Reads ALL relevant design docs and extracts SPECIFIC requirements for this feature. Outputs concrete specs, not summaries.",
      "agent": "design_extractor",
      "config": {
        "inputs": [
          "select_feature"
        ],
        "outputs": []
      },
      "position": {
        "x": 5750,
        "y": 5000
      }
    },
    {
      "id": "review_plan",
      "name": "Review Implementation Plan",
      "type": "reviewer",
      "description": "Reviews the extracted requirements. Checks for completeness, identifies gaps, ensures fidelity to original design docs.",
      "agent": "feature_requirements_reviewer",
      "config": {
        "inputs": [
          "extract_requirements"
        ],
        "outputs": []
      },
      "position": {
        "x": 6100,
        "y": 5000
      }
    },
    {
      "id": "implement_client",
      "name": "Implement Client Feature",
      "type": "implementer",
      "description": "Implements the feature EXACTLY as specified in the reviewed requirements. No generic placeholders.",
      "agent": "client_implementer_v2",
      "config": {
        "inputs": [
          "review_plan"
        ],
        "outputs": []
      },
      "position": {
        "x": 6450,
        "y": 5000
      }
    },
    {
      "id": "implement_server",
      "name": "Implement Server Feature",
      "type": "implementer",
      "description": "Backend code if needed.",
      "agent": "server_implementer",
      "config": {
        "inputs": [
          "implement_client"
        ],
        "outputs": []
      },
      "position": {
        "x": 6800,
        "y": 5000
      }
    },
    {
      "id": "test_feature",
      "name": "Test Feature",
      "type": "validator",
      "description": "Tests syntax, integration paths, and system connections.",
      "agent": "game_tester",
      "config": {
        "inputs": [
          "implement_server"
        ],
        "outputs": []
      },
      "position": {
        "x": 7150,
        "y": 5000
      }
    },
    {
      "id": "integration_test",
      "name": "Play Test Feature",
      "type": "validator",
      "description": "Runs actual gameplay tests. Can request automation infrastructure if needed.",
      "agent": "integration_tester",
      "config": {
        "inputs": [
          "test_feature"
        ],
        "outputs": []
      },
      "position": {
        "x": 7325,
        "y": 5200
      }
    },
    {
      "id": "build_automation",
      "name": "Build Test Automation",
      "type": "implementer",
      "description": "Builds test automation infrastructure on demand - frameworks, hooks, utilities.",
      "agent": "automation_builder",
      "config": {
        "inputs": [
          "integration_test"
        ],
        "outputs": []
      },
      "position": {
        "x": 7325,
        "y": 4800
      }
    },
    {
      "id": "fix_issues",
      "name": "Fix Issues",
      "type": "implementer",
      "description": "Fixes bugs found during testing.",
      "agent": "integration_fixer",
      "config": {
        "inputs": [
          "test_feature",
          "integration_test"
        ],
        "outputs": []
      },
      "position": {
        "x": 7500,
        "y": 5000
      }
    },
    {
      "id": "design_compliance",
      "name": "Check Design Compliance",
      "type": "reviewer",
      "description": "Compares implementation against original design docs. Rejects if it doesn't match the documented design.",
      "agent": "design_compliance_checker",
      "config": {
        "inputs": [
          "fix_issues"
        ],
        "outputs": []
      },
      "position": {
        "x": 6887.5,
        "y": 5200
      }
    },
    {
      "id": "feature_complete",
      "name": "Feature Complete",
      "type": "reviewer",
      "description": "Confirms feature is done. Decides continue or done.",
      "agent": "game_feature_validator",
      "config": {
        "inputs": [
          "design_compliance"
        ],
        "outputs": []
      },
      "position": {
        "x": 6143.75,
        "y": 4800
      }
    }
  ],
  "connections": [
    {
      "from": "assess_state",
      "to": "setup_client",
      "condition": "needs_setup"
    },
    {
      "from": "assess_state",
      "to": "select_feature",
      "condition": "ready_for_features"
    },
    {
      "from": "setup_client",
      "to": "select_feature",
      "condition": "setup_complete"
    },
    {
      "from": "select_feature",
      "to": "extract_requirements",
      "condition": "feature_selected"
    },
    {
      "from": "extract_requirements",
      "to": "review_plan",
      "condition": "requirements_extracted"
    },
    {
      "from": "review_plan",
      "to": "implement_client",
      "condition": "plan_approved"
    },
    {
      "from": "review_plan",
      "to": "extract_requirements",
      "condition": "needs_more_detail"
    },
    {
      "from": "implement_client",
      "to": "implement_server",
      "condition": "needs_backend"
    },
    {
      "from": "implement_client",
      "to": "test_feature",
      "condition": "client_only"
    },
    {
      "from": "implement_server",
      "to": "test_feature",
      "condition": "implementation_complete"
    },
    {
      "from": "test_feature",
      "to": "fix_issues",
      "condition": "has_issues"
    },
    {
      "from": "test_feature",
      "to": "integration_test",
      "condition": "working"
    },
    {
      "from": "integration_test",
      "to": "build_automation",
      "condition": "needs_automation"
    },
    {
      "from": "integration_test",
      "to": "fix_issues",
      "condition": "has_issues"
    },
    {
      "from": "integration_test",
      "to": "design_compliance",
      "condition": "working"
    },
    {
      "from": "build_automation",
      "to": "integration_test",
      "condition": "automation_ready"
    },
    {
      "from": "fix_issues",
      "to": "test_feature",
      "condition": "retry"
    },
    {
      "from": "design_compliance",
      "to": "implement_client",
      "condition": "does_not_match_design"
    },
    {
      "from": "design_compliance",
      "to": "feature_complete",
      "condition": "matches_design"
    },
    {
      "from": "feature_complete",
      "to": "select_feature",
      "condition": "continue"
    }
  ],
  "userContext": "Alright boys we making a Warhammer 40k MMO that plays like guild wars 1 or what. We got documentation. We got backend server archetecture. Look around and build a game client out of our designs that looks and feels like guild wars 1. Inspired in the 40k universe. 3D third-person perspective similar to Guild Wars 1. Continue where we left off - combat needs more validation. \n Henchman fit in perfectly to the 40k system\nSmall tactical missions on rails where you just murder hordes of enemies \nInsane class diversity\nyou can drop little nuggets of tough enemies with the minoris, majoris, extremis, terminus classifications\nlike it's right there\nwhite, blue, yellow, purple enemies\n\nMake sure to use the Guild Wars class\\subclass system + skills systems for insane diversity\nMake sure to use henchmen\\heros",
  "workingDir": "/mnt/c/github/40kgw/output",
  "currentStageIndex": 8,
  "completedStages": [
    "assess_state",
    "select_feature",
    "extract_requirements",
    "review_plan",
    "extract_requirements",
    "review_plan",
    "extract_requirements",
    "review_plan"
  ],
  "status": "running",
  "results": {
    "assess_state": "## Current State\n\n- **Client exists**: Yes - A comprehensive Three.js-based 3D game client exists in `/client/`\n- **Design docs**: Extensive documentation exists:\n  - `combat-design.md` - Full combat system with 12 classes, damage types, status effects\n  - `systems-integration.md` - Complete integration design with balance grades\n  - `progression-design.md` - Level progression systems\n  - `balance-analysis.md` / `balance-audit.md` - Balance documentation\n  - `api-specification.md` - API specs\n  - `data-model.md` - Data structures\n  - Plus additional analysis docs\n- **Backend code**: Full TypeScript/Express backend with:\n  - Auth system (JWT + refresh tokens)\n  - Character models (3 factions, 12 classes)\n  - Combat service with damage calculations\n  - WebSocket combat handler\n  - PostgreSQL database layer with migrations\n  - Skill definitions and validation\n- **Can run**: Yes - Both backend (`npm run dev`) and client (`cd client && npm run dev`) have scripts\n\n### Client Implementation Status:\nThe client has a substantial foundation:\n- Three.js 3D renderer with grim dark atmosphere\n- Player character with movement and collision\n- Third-person camera (Guild Wars 1 style)\n- Entity manager with demo enemies from all factions\n- Combat system with damage types, armor penetration, status effects\n- Skill bar UI (8+1 elite slot)\n- Full skill system with cooldowns and effects\n- Input management (WASD, targeting, skills 1-8/0)\n\n### What's Working:\n- 3D world with gothic buildings, atmospheric particles\n- Player movement with collision detection\n- Enemy spawning (Imperial, Tau, Ork, Tyranid, Chaos)\n- Target selection (Tab/Click)\n- Skill bar with visual feedback\n- Basic combat damage calculations\n\n## Recommendation\n\nThe game client **already exists** and has a solid Guild Wars 1-style foundation. The user mentioned \"combat needs more validation\" - the backend combat service exists but needs the client-side combat to be fully connected and validated against server state. The client also needs:\n\n1. **Combat validation** - Skill usage should validate against server\n2. **Henchmen/Heroes system** - Not yet implemented (perfect for 40K)\n3. **Enemy threat classification** - Minoris/Majoris/Extremis/Terminus (white/blue/yellow/purple) visual indicators\n4. **Skill diversity** - More skills implementing the design doc specifications\n\nDECISION: ready_for_features",
    "select_feature": "Now I have a complete picture. Let me provide my feature selection.\n\n## Next Feature: Henchmen/Heroes System\n\n### Already Implemented\n- **Player character**: Sprite that moves with WASD/arrows ✓\n- **Basic map/world**: Tile-based 3D environment with gothic buildings ✓\n- **Collision**: Walls block movement ✓\n- **Enemy spawning**: Enemies from all factions appear ✓\n- **Basic combat**: Combat system with 8 damage types, armor penetration, status effects ✓\n- **Health/death**: HP system with health/energy bars ✓\n- **UI elements**: Health bar, skill bar (8+1), target frame, chat, HUD ✓\n- **Skills system**: GW1-style skill bar with cooldowns, skill trees, training ✓\n- **Classes**: 12 character classes across 3 factions with abilities ✓\n- **Secondary profession**: Trial and commitment system ✓\n- **Network layer**: REST/WebSocket communication stub ✓\n\n### Why This Feature\nThe user explicitly mentioned \"Henchman fit in perfectly to the 40k system\" and \"Make sure to use henchmen/heroes\" - this is a core GW1 mechanic that's NOT yet implemented. The search for \"hench|hero|companion|ally\" in the client folder returned only library files (no game code).\n\nThe client has:\n- All basic gameplay features complete\n- Full skill/class system\n- Enemy templates with faction support\n- Party frame UI (exists but only shows placeholder data)\n\nWhat's missing for the GW1 experience:\n1. **Henchmen/Heroes** - NPCs that join your party and fight alongside you (critical for small tactical missions)\n2. **Threat Classification** - minoris/majoris/extremis/terminus (white/blue/yellow/purple) enemy indicators as mentioned by user\n3. **Combat server validation** - mentioned as needing work\n\nGiven the user's emphasis on henchmen being \"perfect for 40K\", this should be the next feature.\n\nDECISION: feature_selected",
    "extract_requirements": "Based on my research, I'll now compile the complete requirements extraction document for the Henchmen/Heroes System, using authentic GW1 mechanics and Space Marine 2 threat tiers (not Darktide as originally stated).\n\n---\n\n# REQUIREMENTS EXTRACTION: Henchmen/Heroes System\n\n## Feature Overview\n\nThe Henchmen/Heroes System provides AI-controlled squad companions for the Warhammer 40K MMO, directly adapted from Guild Wars 1's proven companion system. This enables solo and small-group players to experience full tactical combat while maintaining the 40K squad fantasy.\n\n---\n\n## REQUIREMENTS FROM DESIGN DOCS\n\n### Existing Foundation (from design-docs/)\n\n**Party System (api-specification.md, systems-integration.md):**\n- Maximum party size: 4 players for standard content\n- PvE party configurations: 2, 4, 6, 8, or 12 characters total (matching GW1)\n- Empty player slots can be filled with Henchmen or Heroes\n\n**Class System (progression-design.md):**\n- 12 classes across 3 factions (Imperial, Tau, Ork)\n- Each class has access to 50+ skills, selects 8 for skill bar + 1 elite\n- Secondary profession system after level 10\n- Level cap: 30\n\n**Summon Limits (combat-design.md):**\n- Maximum 2 active constructs/summons per player\n- Henchmen/Heroes are SEPARATE from summon limits (they are party members, not summons)\n\n---\n\n## REQUIREMENTS FROM GUILD WARS 1 RESEARCH\n\n### Henchmen System (Authentic GW1 Mechanics)\n\n**Definition:** Fixed AI companions available at outposts/mission hubs with preset builds.\n\n| Specification | GW1 Authentic Value | 40K Adaptation |\n|---------------|---------------------|----------------|\n| Skill Customization | None - fixed skills based on profession | None - fixed loadout per henchman type |\n| Attribute Customization | None - fixed attributes | None - preset builds |\n| Equipment Customization | None - fixed gear | None - standardized faction gear |\n| Level | Matches outpost/zone level | Matches mission difficulty level |\n| Cost to Acquire | Free | Free (unlocked via story progression) |\n| Movement Speed | 104% of player speed | 104% of player speed |\n| Positioning Control | None in original GW1 | None |\n| Death Penalty | Takes full death penalty | Takes appropriate penalty per design |\n\n**Henchman Archetypes per Faction (12 total, 4 per faction):**\n\n*Imperial:*\n1. **Guardsman** - Ranged DPS, fixed lasgun build\n2. **Medicae** - Healer, fixed support build\n3. **Ogryn** - Tank, fixed melee/taunt build\n4. **Psyker Adept** - Caster DPS, fixed psychic build\n\n*Tau:*\n1. **Fire Warrior** - Ranged DPS, fixed pulse rifle build\n2. **Earth Caste Medic** - Healer, fixed drone-support build\n3. **Crisis Suit Pilot** - Tank, fixed battlesuit build\n4. **Ethereal Acolyte** - Support/Buffer, fixed aura build\n\n*Ork:*\n1. **Shoota Boy** - Ranged DPS, fixed dakka build\n2. **Painboy Assistant** - Healer, fixed brutal healing build\n3. **'Ard Boy** - Tank, fixed heavy armor melee build\n4. **Weirdboy Grot** - Caster DPS, fixed WAAAGH! magic build\n\n---\n\n### Heroes System (Authentic GW1 Mechanics)\n\n**Definition:** Fully customizable AI companions that players unlock and develop.\n\n| Specification | GW1 Authentic Value | 40K Adaptation |\n|---------------|---------------------|----------------|\n| Skill Customization | Full - any unlocked skill from account pool | Full - any skill unlocked for that class |\n| Attribute Customization | Full - player allocates attribute points | Full - player allocates attribute points |\n| Equipment Customization | Weapons: manual. Armor: auto-scales to level | Weapons: manual. Armor: auto-scales |\n| Level | Matches player level | Matches player level |\n| Cost to Acquire | Story unlock or special acquisition | Story unlock, reputation, or requisition |\n| Movement Speed | 104% of player speed | 104% of player speed |\n| Positioning Control | Flag system for precise placement | Flag system for tactical positioning |\n| Combat Stance | Passive / Attack / Guard | Passive / Attack / Guard |\n| Skill Suppression | Can disable specific skills | Can disable specific skills |\n\n**Hero Attribute Points (GW1 Authentic):**\n- Heroes gain attribute points at the same rate as players\n- Heroes receive +15 bonus attribute points at level 10\n- Heroes receive +15 bonus attribute points at level 15\n- Total at level 30: Standard allocation + 30 bonus points\n\n**Hero Combat Stances:**\n1. **Attack** - Aggressively engages enemies, uses skills freely\n2. **Guard** - Defends position, only attacks threats to self or flagged allies\n3. **Passive** - Does not attack, only uses defensive/healing skills\n\n**Hero Flag System:**\n- Players can place positioning flags on the battlefield\n- Heroes move to and hold flagged positions\n- Flags can be set per-hero or as group command\n- Clear flag returns hero to follow behavior\n\n---\n\n## REQUIREMENTS FROM SPACE MARINE 2 RESEARCH\n\n### Enemy Threat Tier System\n\n**Critical Clarification:** The minoris/majoris/extremis/terminus system is from **Warhammer 40,000: Space Marine 2**, NOT Darktide. Darktide uses armor-type classifications (Flak, Unarmored, Carapace, Maniacs, Unyielding, Infested).\n\n| Threat Tier | SM2 Definition | Visual Indicator | Spawn Pattern |\n|-------------|----------------|------------------|---------------|\n| **Minoris** | Weakest enemies, instantly killed on parry | White indicator | Large packs (10-20+) |\n| **Majoris** | Player-sized, significantly tougher | Blue indicator | Small groups (3-6) |\n| **Extremis** | Miniboss units, appear in kill feed | Yellow indicator | Solo or pairs |\n| **Terminus** | Full boss units with health bars | Purple indicator | Solo, scripted encounters |\n\n**Space Marine 2 Threat Tier Behaviors:**\n- **Minoris:** Can be cleaved through, exist to make players feel powerful\n- **Majoris:** Require focused attention, can call reinforcements, varied attack patterns\n- **Extremis:** Require tactical approach, have unique mechanics, execution animations on kill\n- **Terminus:** Phase-based fights, visible health bars, encounter-defining mechanics\n\n---\n\n## INTEGRATION WITH EXISTING SYSTEMS\n\n### Party Composition Rules\n\n```\nMaximum Party Size: 4-12 (based on content type)\n\nComposition Options:\n- 4-player content: Up to 3 Henchmen/Heroes if solo\n- 8-player content: Up to 7 Henchmen/Heroes if solo\n- 12-player content: Up to 11 Henchmen/Heroes if solo\n\nRestrictions:\n- Heroes limited to 3 per player in party\n- Henchmen have no limit beyond party size\n- PvP: Heroes allowed in specific formats only\n- Competitive PvP: No Henchmen/Heroes\n```\n\n### Hero Skill Access\n\nHeroes can use:\n- Any skill the player has unlocked for that hero's class\n- Skills from secondary profession if hero has one assigned\n- Elite skills if player has captured them for that class\n\nHeroes cannot use:\n- Player-specific skills (e.g., leadership rallies that require player input)\n- PvP-only skills in PvE contexts\n\n### Faction-Locked Heroes\n\n- Imperial heroes only available to Imperial players\n- Tau heroes only available to Tau players  \n- Ork heroes only available to Ork players\n- Cross-faction heroes: Special story unlocks (e.g., defector characters)\n\n---\n\n## DATA MODEL ADDITIONS\n\n### New Tables Required\n\n```sql\n-- Henchman definitions (static game data)\nCREATE TABLE henchmen (\n    id UUID PRIMARY KEY,\n    name VARCHAR(100) NOT NULL,\n    faction_id UUID REFERENCES factions(id),\n    class_id UUID REFERENCES classes(id),\n    description TEXT,\n    unlock_requirement JSONB, -- story progress, reputation, etc.\n    fixed_skill_bar UUID[], -- 8 skill references\n    fixed_attributes JSONB, -- attribute allocations\n    created_at TIMESTAMP DEFAULT NOW()\n);\n\n-- Hero definitions (player-owned, customizable)\nCREATE TABLE player_heroes (\n    id UUID PRIMARY KEY,\n    player_id UUID REFERENCES players(id),\n    hero_template_id UUID REFERENCES hero_templates(id),\n    name VARCHAR(100) NOT NULL,\n    level INTEGER DEFAULT 1,\n    experience BIGINT DEFAULT 0,\n    class_id UUID REFERENCES classes(id),\n    secondary_class_id UUID REFERENCES classes(id),\n    skill_bar UUID[], -- 8 regular + 1 elite\n    disabled_skills UUID[], -- suppressed skills\n    attributes JSONB, -- allocated points\n    equipment JSONB, -- weapon slots\n    combat_stance VARCHAR(20) DEFAULT 'attack', -- passive/attack/guard\n    created_at TIMESTAMP DEFAULT NOW(),\n    updated_at TIMESTAMP DEFAULT NOW()\n);\n\n-- Hero templates (unlockable hero characters)\nCREATE TABLE hero_templates (\n    id UUID PRIMARY KEY,\n    name VARCHAR(100) NOT NULL,\n    faction_id UUID REFERENCES factions(id),\n    class_id UUID REFERENCES classes(id),\n    backstory TEXT,\n    unlock_requirement JSONB,\n    portrait_asset VARCHAR(255),\n    model_asset VARCHAR(255),\n    voice_set VARCHAR(100),\n    created_at TIMESTAMP DEFAULT NOW()\n);\n\n-- Enemy threat tier classification\nALTER TABLE enemy_templates ADD COLUMN threat_tier VARCHAR(20) \n    CHECK (threat_tier IN ('minoris', 'majoris', 'extremis', 'terminus'));\n```\n\n---\n\n## API ENDPOINTS REQUIRED\n\n### Henchmen Endpoints\n\n```\nGET /api/v1/henchmen\n  - Returns available henchmen for player's faction and current zone\n  - Query params: zone_id, faction_id\n\nGET /api/v1/henchmen/:id\n  - Returns specific henchman details including fixed build\n```\n\n### Hero Endpoints\n\n```\nGET /api/v1/heroes\n  - Returns all heroes owned by authenticated player\n\nGET /api/v1/heroes/:id\n  - Returns specific hero with full customization details\n\nPOST /api/v1/heroes/:id/skills\n  - Update hero's skill bar\n  - Body: { skill_bar: UUID[], elite_skill: UUID }\n\nPOST /api/v1/heroes/:id/attributes\n  - Update hero's attribute allocation\n  - Body: { attributes: { strength: number, ... } }\n\nPOST /api/v1/heroes/:id/equipment\n  - Equip weapon to hero\n  - Body: { slot: string, item_id: UUID }\n\nPOST /api/v1/heroes/:id/stance\n  - Set combat stance\n  - Body: { stance: 'passive' | 'attack' | 'guard' }\n\nPOST /api/v1/heroes/:id/disable-skill\n  - Toggle skill suppression\n  - Body: { skill_id: UUID, disabled: boolean }\n```\n\n### Party Composition Endpoints\n\n```\nPOST /api/v1/party/add-henchman\n  - Add henchman to party\n  - Body: { henchman_id: UUID }\n\nPOST /api/v1/party/add-hero\n  - Add hero to party\n  - Body: { hero_id: UUID }\n\nPOST /api/v1/party/remove-companion\n  - Remove henchman or hero from party\n  - Body: { companion_id: UUID, type: 'henchman' | 'hero' }\n\nPOST /api/v1/party/flag\n  - Set positioning flag for hero(es)\n  - Body: { hero_ids: UUID[], position: { x, y, z } }\n\nPOST /api/v1/party/clear-flags\n  - Clear all positioning flags\n```\n\n---\n\n## WEBSOCKET COMBAT INTEGRATION\n\n### New Message Types\n\n```typescript\n// Client -> Server\ninterface HeroCommand {\n    type: 'hero_command';\n    hero_id: string;\n    command: 'move' | 'attack' | 'use_skill' | 'stance' | 'flag';\n    target_id?: string;\n    position?: { x: number; y: number; z: number };\n    skill_id?: string;\n    stance?: 'passive' | 'attack' | 'guard';\n}\n\n// Server -> Client\ninterface CompanionStateUpdate {\n    type: 'companion_state';\n    companions: Array<{\n        id: string;\n        type: 'henchman' | 'hero';\n        health: number;\n        max_health: number;\n        position: { x: number; y: number; z: number };\n        current_target?: string;\n        stance: string;\n        active_effects: string[];\n        skill_cooldowns: Record<string, number>;\n    }>;\n}\n\ninterface CompanionAction {\n    type: 'companion_action';\n    companion_id: string;\n    action: 'skill_use' | 'attack' | 'move' | 'death' | 'resurrect';\n    skill_id?: string;\n    target_id?: string;\n    damage?: number;\n    healing?: number;\n}\n```\n\n---\n\n## AI BEHAVIOR SPECIFICATIONS\n\n### Henchman AI (Simple)\n\n```\nPriority Order:\n1. Self-preservation (flee at <20% health if healer available)\n2. Heal allies (if healer class)\n3. Protect low-health allies (if tank class)\n4. Attack player's target\n5. Attack nearest threat\n6. Follow player\n\nRestrictions:\n- No skill timing optimization\n- No combo awareness\n- Basic threat assessment only\n```\n\n### Hero AI (Advanced)\n\n```\nPriority Order (modified by stance):\n\nATTACK Stance:\n1. Use elite skill when high-value target available\n2. Maintain buffs/preparations\n3. Attack flagged target or player's target\n4. Use AoE on grouped enemies\n5. Attack nearest threat\n6. Move to flagged position or follow player\n\nGUARD Stance:\n1. Heal/protect flagged ally or lowest-health ally\n2. Interrupt dangerous enemy skills\n3. Only attack threats to guarded targets\n4. Maintain defensive position\n\nPASSIVE Stance:\n1. Heal allies only\n2. Apply defensive buffs\n3. Do not attack under any circumstances\n4. Follow player or hold position\n\nAdvanced Behaviors:\n- Skill combo awareness (set up and follow through)\n- Energy/resource management\n- Interrupt priority targets\n- Positioning for AoE effectiveness\n- Avoid AoE damage zones\n```\n\n---\n\n## IMPLEMENTATION CHECKLIST\n\n### Phase 1: Data Layer\n- [ ] Create `henchmen` table with migration\n- [ ] Create `hero_templates` table with migration\n- [ ] Create `player_heroes` table with migration\n- [ ] Add `threat_tier` column to `enemy_templates`\n- [ ] Create Henchman repository\n- [ ] Create Hero repository\n- [ ] Seed initial henchmen (4 per faction = 12 total)\n- [ ] Seed initial hero templates (4 per faction = 12 total)\n\n### Phase 2: Service Layer\n- [ ] Create HenchmanService with getAvailableHenchmen(), getHenchmanById()\n- [ ] Create HeroService with full CRUD operations\n- [ ] Create HeroCustomizationService for skill/attribute/equipment management\n- [ ] Extend PartyService to handle henchman/hero additions\n- [ ] Create CompanionAIService for behavior processing\n\n### Phase 3: API Layer\n- [ ] Implement henchmen endpoints (GET list, GET by ID)\n- [ ] Implement hero endpoints (full CRUD + customization)\n- [ ] Implement party composition endpoints\n- [ ] Add validation schemas for all new endpoints\n- [ ] Add hero ownership middleware\n\n### Phase 4: WebSocket Integration\n- [ ] Add HeroCommand message handler\n- [ ] Add CompanionStateUpdate broadcast\n- [ ] Add CompanionAction broadcast\n- [ ] Integrate companion AI into combat tick\n- [ ] Implement flag system for positioning\n\n### Phase 5: AI Implementation\n- [ ] Implement basic henchman AI behavior tree\n- [ ] Implement advanced hero AI with stance awareness\n- [ ] Add skill combo detection and execution\n- [ ] Add threat assessment and target prioritization\n- [ ] Add positioning and movement AI\n\n### Phase 6: Testing\n- [ ] Unit tests for Henchman/Hero services\n- [ ] Integration tests for API endpoints\n- [ ] WebSocket integration tests for combat scenarios\n- [ ] AI behavior tests for each stance\n- [ ] Party composition validation tests\n\n---\n\n## VALIDATION RULES\n\n### Hero Customization Validation\n- Skill bar must contain exactly 8 skills + 1 elite (or empty slots)\n- All skills must be unlocked by player for hero's class\n- Secondary class skills only valid if secondary profession assigned\n- Attribute points cannot exceed level-based maximum + bonuses\n- Equipment must match hero's class proficiency\n\n### Party Composition Validation\n- Total companions ≤ (max party size - human players)\n- Maximum 3 heroes per player in party\n- Henchmen must be available in current zone\n- No duplicate heroes (same hero template twice)\n\n---\n\n## OPEN DESIGN DECISIONS\n\nThe following require design team input before implementation:\n\n1. **Hero Acquisition:** GW1 uses story unlocks. Options for 40K:\n   - Story progression unlocks\n   - Faction reputation thresholds\n   - Requisition currency purchase\n   - Achievement unlocks\n\n2. **Cross-Faction Heroes:** Should defector/mercenary heroes exist?\n   - Lore-friendly options (Rogue Traders, Kroot mercenaries)\n   - Keep strictly faction-locked for purity\n\n3. **Hero Death Penalty:** GW1 heroes take full death penalty. Options:\n   - Full penalty (authentic)\n   - Reduced penalty (more forgiving)\n   - No penalty (heroes are expendable)\n\n4. **Henchman Availability:** Which henchmen appear where?\n   - Zone-based (GW1 authentic)\n   - Always available once unlocked\n   - Story-gated availability\n\n---\n\n**DECISION: requirements_extracted**",
    "review_plan": "Now I have thoroughly reviewed the design documents. Let me compile my review of the extracted requirements.\n\n---\n\n## Review: NEEDS MORE DETAIL\n\n### What's Correct in the Extracted Requirements\n\nThe extracted requirements accurately capture:\n- GW1 Henchmen mechanics (fixed skills, no customization)\n- GW1 Heroes mechanics (full skill/attribute customization, flag system, stances)\n- 104% movement speed for companions (authentic GW1 detail)\n- Correct attribution of threat tier system to Space Marine 2 (not Darktide)\n- Minoris/Majoris/Extremis/Terminus classification with color coding (white/blue/yellow/purple)\n\n### Missing Information\n\n**1. Critical: Level Cap Discrepancy**\n- Extracted requirements state \"Level cap: 30\"\n- But from `progression-design.md` line 27-28:\n  - \"Level Cap: 30 (Guild Wars 1 style - achievable, not endless)\"\n- However, the requirements reference \"level 10, level 15\" bonuses for Heroes that mirror GW1's level 20 cap system, not level 30\n- **Need clarification:** Should hero attribute bonuses occur at levels 10 and 15, or at levels 15 and 20 (scaled from GW1's 20 cap)?\n\n**2. Party Size Specifications**\n- From `api-specification.md` lines 1406-1430 and `systems-integration.md` line 183-193:\n  - Standard party size: 4 players\n  - Raid content: 8 players\n  - The extracted requirements mention \"4, 6, 8, or 12\" but docs show primarily 4 and 8\n- **Need verification:** Are 6 and 12 player configurations supported, or just 4 and 8?\n\n**3. Summon Limit Clarification**\n- From `combat-design.md` line 336: \"Summon Limit: 2 active constructs maximum\" (Tech-Priest specific)\n- The requirements correctly state Heroes/Henchmen are NOT summons\n- But should clarify: Does adding a Hero that is a Tech-Priest with summons affect the player's summon limit?\n\n**4. Henchman/Hero Archetypes Missing Details**\n- The requirements created archetypes (Guardsman, Medicae, Ogryn, Psyker Adept, etc.) but these are **NOT in the design documents**\n- These appear to be reasonable extrapolations but are **invented requirements**\n- Design docs don't specify which henchmen/heroes should exist\n- **Red Flag:** This is inventing content not in the source docs\n\n**5. Faction Lock Implementation**\n- Requirements state \"Imperial heroes only available to Imperial players\"\n- But from `progression-design.md` line 1517-1524, the secondary profession system allows cross-class access\n- **Need clarification:** Can a player have a Hero from a different faction if they have cross-faction progression?\n\n**6. Death Penalty Not Specified**\n- Requirements list this as \"Open Design Decision\"\n- But from `combat-design.md` lines 1016-1043, death penalty is defined by difficulty mode:\n  - Normal: respawn at waypoint, minor durability loss\n  - Hard: respawn at checkpoint, moderate durability loss\n  - Veteran: 3 respawns per mission\n  - Nightmare: party wipe = failure\n- Heroes/Henchmen should inherit these rules but specific behavior not defined\n\n**7. Missing: WebSocket Combat Tick Integration**\n- Requirements mention \"Integrate companion AI into combat tick\"\n- But `api-specification.md` line 1214 shows server tick rate: 20 ticks/second\n- Should specify how companion AI integrates with this tick rate\n\n### Docs to Check\n\n1. **Re-read combat-design.md** for:\n   - Existing party composition examples\n   - Death penalty specifics by difficulty\n   - How summons from Tech-Priest/Crisis Suit interact with party limits\n\n2. **Check for any henchmen/heroes references** that may have been missed:\n   - Search for \"henchmen\", \"companion\", \"follower\" in all docs\n   - The requirements created archetypes that don't exist in source docs\n\n3. **Verify party sizes** from systems-integration.md and api-specification.md\n\n### Red Flags Found\n\n1. **Invented Henchman/Hero archetypes** - The 12 henchmen and 12 hero templates listed are reasonable extrapolations from the class system but are NOT specified in the design documents. This creates risk of implementing something the designers didn't intend.\n\n2. **Generic database schema** - The SQL tables look reasonable but weren't validated against the existing `data-model.md` which has detailed schemas. Should align with existing table patterns.\n\n3. **Hero attribute bonus timing** - \"+15 bonus at level 10, +15 at level 15\" appears to be adapted from GW1's level 20 cap without validation against this game's level 30 cap.\n\n---\n\nDECISION: needs_more_detail"
  },
  "currentStage": "Extract Design Requirements",
  "pid": 236878
}