# Implementation Plan: Hover-to-Open RadialHUD with Progress Indicator

## Architecture

### New Classes/Components

```json
{
  "newComponents": [
    {
      "name": "HoverTimerSystem",
      "responsibility": "Manages hover state tracking, timer logic, and threshold detection",
      "location": "/mnt/c/github/superstarships/js/ui/HoverTimerSystem.js",
      "methods": [
        "startHover(shipId, cursorPosition)",
        "updateHoverProgress(deltaTime)",
        "cancelHover()",
        "isHovering()",
        "getProgress()",
        "onHoverComplete(callback)"
      ],
      "state": {
        "isActive": "boolean",
        "startTime": "number (timestamp)",
        "targetDuration": "number (500ms)",
        "currentProgress": "number (0-1)",
        "targetShipId": "string",
        "cursorPosition": "{x, y}",
        "completionCallback": "function"
      }
    },
    {
      "name": "HoverProgressIndicator",
      "responsibility": "Renders visual progress feedback during hover",
      "location": "/mnt/c/github/superstarships/js/ui/HoverProgressIndicator.js",
      "methods": [
        "show(position)",
        "hide()",
        "updateProgress(progress)",
        "render()",
        "setPosition(x, y)"
      ],
      "visualType": "Circular fill (radial progress)",
      "rendering": "HTML/CSS overlay positioned near cursor or ship"
    }
  ],
  "modifiedClasses": [
    {
      "name": "RadialHUD",
      "file": "/mnt/c/github/superstarships/js/ui/RadialHUD.js",
      "changes": [
        "Remove immediate show() call on mouse hover",
        "Add integration with HoverTimerSystem",
        "Add check to prevent hover timer when HUD already visible",
        "Add click bypass logic (optional: click immediately opens HUD)"
      ],
      "newDependencies": [
        "HoverTimerSystem",
        "HoverProgressIndicator"
      ]
    },
    {
      "name": "SpaceshipSimulator (or InputManager)",
      "file": "/mnt/c/github/superstarships/js/SpaceshipSimulator.js",
      "changes": [
        "Add mouse hover detection via raycasting",
        "Track mouse enter/exit events for ship mesh",
        "Call HoverTimerSystem.startHover() on ship hover enter",
        "Call HoverTimerSystem.cancelHover() on ship hover exit",
        "Update HoverTimerSystem in game loop (update cycle)"
      ]
    }
  ],
  "patterns": [
    "Observer pattern: HoverTimerSystem notifies RadialHUD on completion",
    "State machine: Hover states (idle → hovering → completing → completed)",
    "Timestamp-based timing: Use performance.now() for accurate 500ms detection",
    "Component composition: RadialHUD delegates hover logic to HoverTimerSystem"
  ]
}
```

### Integration Points

```
Game Loop (SpaceshipSimulator.update())
  ├─> Mouse Raycast Detection
  │     └─> Detects ship under cursor
  │           ├─> On Enter: HoverTimerSystem.startHover(shipId)
  │           └─> On Exit: HoverTimerSystem.cancelHover()
  │
  ├─> HoverTimerSystem.updateHoverProgress(deltaTime)
  │     ├─> Calculates progress (0-1)
  │     ├─> Updates HoverProgressIndicator visual
  │     └─> On 100% → Triggers onHoverComplete callback
  │
  └─> HoverProgressIndicator.render()
        └─> Draws circular progress indicator near cursor/ship
```

## File Structure

### Files to Create

```json
{
  "create": [
    {
      "path": "/mnt/c/github/superstarships/js/ui/HoverTimerSystem.js",
      "description": "Core hover timer logic with threshold detection",
      "estimatedLines": 150
    },
    {
      "path": "/mnt/c/github/superstarships/js/ui/HoverProgressIndicator.js",
      "description": "Visual progress indicator component (circular fill)",
      "estimatedLines": 120
    },
    {
      "path": "/mnt/c/github/superstarships/css/hover-progress.css",
      "description": "Styling for hover progress indicator",
      "estimatedLines": 60
    },
    {
      "path": "/mnt/c/github/superstarships/tests/test_hover_radial_hud.js",
      "description": "Automated test script for hover functionality",
      "estimatedLines": 300
    }
  ]
}
```

### Files to Modify

```json
{
  "modify": [
    {
      "path": "/mnt/c/github/superstarships/js/ui/RadialHUD.js",
      "sections": [
        "Constructor: Initialize HoverTimerSystem and HoverProgressIndicator",
        "Show method: Add check to prevent show if HoverTimerSystem is active",
        "Add new method: onHoverComplete() to handle delayed opening",
        "Add new method: resetHoverState() for cleanup"
      ],
      "estimatedChanges": "50-70 lines"
    },
    {
      "path": "/mnt/c/github/superstarships/js/SpaceshipSimulator.js",
      "sections": [
        "update() method: Add HoverTimerSystem.updateHoverProgress() call",
        "handleMouseMove() or raycasting section: Add ship hover detection logic",
        "Add mouse enter/exit tracking for ship mesh",
        "Add click handler to bypass hover timer (optional)"
      ],
      "estimatedChanges": "60-80 lines"
    },
    {
      "path": "/mnt/c/github/superstarships/index.html",
      "sections": [
        "Add <script> tag for HoverTimerSystem.js",
        "Add <script> tag for HoverProgressIndicator.js",
        "Add <link> tag for hover-progress.css"
      ],
      "estimatedChanges": "3 lines"
    },
    {
      "path": "/mnt/c/github/superstarships/css/radial-hud.css",
      "sections": [
        "Optional: Add transition styles for smoother HUD appearance after hover"
      ],
      "estimatedChanges": "5-10 lines (optional)"
    }
  ]
}
```

## Implementation Steps

```json
{
  "steps": [
    {
      "order": 1,
      "task": "Create HoverTimerSystem.js class structure",
      "description": "Implement core timer logic with state tracking (idle, hovering, completed)",
      "estimatedTime": "45 minutes",
      "dependencies": [],
      "technicalDetails": [
        "Use performance.now() for timestamp-based timing",
        "Implement startHover(), cancelHover(), updateHoverProgress(), getProgress()",
        "Add callback registration for hover completion event",
        "Handle edge case: prevent hover restart if already hovering same ship"
      ],
      "testingNote": "Unit test timer accuracy: ensure 500ms threshold is met within ±50ms"
    },
    {
      "order": 2,
      "task": "Create HoverProgressIndicator.js visual component",
      "description": "Implement circular progress indicator using HTML/CSS overlay",
      "estimatedTime": "1 hour",
      "dependencies": [],
      "technicalDetails": [
        "Create DOM element for progress indicator (div with circular SVG or CSS)",
        "Position indicator near cursor or ship (screen coordinates)",
        "Implement updateProgress(0-1) to animate fill",
        "Add show()/hide() methods with smooth fade transitions",
        "Use requestAnimationFrame for smooth 60fps updates"
      ],
      "visualDesign": {
        "type": "Circular radial fill",
        "size": "50px diameter",
        "style": "Semi-transparent ring that fills clockwise from 0° to 360°",
        "colors": {
          "background": "rgba(255, 255, 255, 0.2)",
          "fill": "rgba(0, 200, 255, 0.8)",
          "complete": "rgba(0, 255, 100, 1.0)"
        }
      },
      "testingNote": "Visual inspection: verify smooth animation from 0% to 100%"
    },
    {
      "order": 3,
      "task": "Create hover-progress.css stylesheet",
      "description": "Style the hover progress indicator component",
      "estimatedTime": "20 minutes",
      "dependencies": [2],
      "technicalDetails": [
        "Position indicator using absolute positioning",
        "Add CSS transitions for smooth show/hide",
        "Style circular progress ring (SVG or clip-path)",
        "Ensure high z-index to appear above game canvas"
      ]
    },
    {
      "order": 4,
      "task": "Add ship hover detection to SpaceshipSimulator.js",
      "description": "Implement raycasting to detect when cursor hovers over ship mesh",
      "estimatedTime": "1 hour",
      "dependencies": [],
      "technicalDetails": [
        "Add raycaster in update() or mouse move handler",
        "Cast ray from camera through mouse position",
        "Check intersection with ship mesh",
        "Track previousHoveredShip to detect enter/exit events",
        "On hover enter: call HoverTimerSystem.startHover(shipId, cursorPos)",
        "On hover exit: call HoverTimerSystem.cancelHover()"
      ],
      "edgeCases": [
        "Multiple ships overlapping: use first intersected ship",
        "Camera angle changes: re-raycast each frame",
        "Ship destroyed during hover: cancel timer"
      ],
      "testingNote": "Browser automation: verify hover enter/exit events fire correctly"
    },
    {
      "order": 5,
      "task": "Integrate HoverTimerSystem update into game loop",
      "description": "Add HoverTimerSystem.updateHoverProgress() to SpaceshipSimulator.update()",
      "estimatedTime": "30 minutes",
      "dependencies": [1, 4],
      "technicalDetails": [
        "Call HoverTimerSystem.updateHoverProgress(deltaTime) each frame",
        "Pass elapsed time since last frame (deltaTime or calculate from timestamps)",
        "System internally calculates progress and triggers completion callback",
        "Update HoverProgressIndicator position each frame (follow cursor or ship)"
      ],
      "testingNote": "Performance test: ensure no FPS drop during hover tracking"
    },
    {
      "order": 6,
      "task": "Modify RadialHUD.js to use HoverTimerSystem",
      "description": "Replace immediate show() with hover completion callback",
      "estimatedTime": "45 minutes",
      "dependencies": [1, 2],
      "technicalDetails": [
        "Remove immediate show() call from existing hover logic",
        "Initialize HoverTimerSystem and HoverProgressIndicator in constructor",
        "Register callback: HoverTimerSystem.onHoverComplete(() => this.show())",
        "Add check in show(): if HUD already visible, prevent hover timer restart",
        "Add resetHoverState() method to cleanup on HUD close"
      ],
      "stateManagement": {
        "hudVisible": "boolean - prevents hover timer when HUD open",
        "hoverTimerActive": "boolean - from HoverTimerSystem.isHovering()"
      },
      "testingNote": "Test TC-006: verify no hover timer when HUD already open"
    },
    {
      "order": 7,
      "task": "Add click bypass functionality (optional)",
      "description": "Allow clicking ship to immediately open HUD, bypassing hover timer",
      "estimatedTime": "30 minutes",
      "dependencies": [6],
      "technicalDetails": [
        "Add click event listener in SpaceshipSimulator or InputManager",
        "On click: raycast to detect ship under cursor",
        "If ship clicked: immediately call RadialHUD.show(), cancel hover timer",
        "Ensure click doesn't interfere with existing click behaviors (targeting, etc.)"
      ],
      "testingNote": "Test TC-008: verify click during hover immediately opens HUD"
    },
    {
      "order": 8,
      "task": "Update index.html to include new files",
      "description": "Add script and CSS tags for new components",
      "estimatedTime": "5 minutes",
      "dependencies": [1, 2, 3],
      "changes": [
        "<script src=\"js/ui/HoverTimerSystem.js\"></script>",
        "<script src=\"js/ui/HoverProgressIndicator.js\"></script>",
        "<link rel=\"stylesheet\" href=\"css/hover-progress.css\">"
      ]
    },
    {
      "order": 9,
      "task": "Manual testing and edge case validation",
      "description": "Test all acceptance criteria and edge cases",
      "estimatedTime": "1 hour",
      "dependencies": [1, 2, 3, 4, 5, 6, 7, 8],
      "testCases": [
        "Hover for 0.1s, move away → HUD should NOT open",
        "Hover for 0.5s continuously → HUD should open",
        "Hover for 0.3s, move away, hover again → Timer should reset",
        "Progress indicator visible during hover",
        "Progress indicator disappears on hover cancel",
        "HUD already open, hover again → No progress indicator",
        "Rapid hover spam (10 quick hovers) → HUD should NOT open"
      ],
      "testingNote": "Use browser DevTools to log hover events and timer states"
    },
    {
      "order": 10,
      "task": "Create automated test script (test_hover_radial_hud.js)",
      "description": "Implement browser automation tests from test plan",
      "estimatedTime": "2 hours",
      "dependencies": [9],
      "technicalDetails": [
        "Use Puppeteer or Playwright for browser automation",
        "Implement all 8 test cases from test plan",
        "Capture evidence JSON files for each test",
        "Verify timing accuracy (500ms ± 50ms)",
        "Test progress indicator visibility and updates",
        "Test rapid hover spam prevention"
      ],
      "testingNote": "Run full automated test suite, verify all tests pass"
    },
    {
      "order": 11,
      "task": "Performance optimization and polish",
      "description": "Optimize hover detection and progress rendering",
      "estimatedTime": "45 minutes",
      "dependencies": [10],
      "optimizations": [
        "Throttle raycasting to every 2-3 frames if performance issue",
        "Use CSS transforms for progress indicator (GPU acceleration)",
        "Minimize DOM updates (batch progress updates)",
        "Add smooth easing to progress animation (ease-out)",
        "Ensure no memory leaks (cleanup on hover cancel)"
      ],
      "testingNote": "Profile with Chrome DevTools: verify no FPS drops during hover"
    },
    {
      "order": 12,
      "task": "Documentation and code comments",
      "description": "Add inline documentation and update CLAUDE.md",
      "estimatedTime": "30 minutes",
      "dependencies": [11],
      "documentation": [
        "Add JSDoc comments to HoverTimerSystem methods",
        "Add JSDoc comments to HoverProgressIndicator methods",
        "Document hover detection logic in SpaceshipSimulator.js",
        "Update CLAUDE.md with hover timer system details",
        "Add section in README about new hover interaction"
      ]
    }
  ]
}
```

## Technical Considerations

### Performance

```json
{
  "performance": {
    "hoverDetection": {
      "approach": "Raycasting each frame",
      "optimization": "Only raycast when mouse moves (track lastMousePosition)",
      "fallback": "If FPS < 30, throttle raycasting to every 3rd frame",
      "cost": "Minimal - single raycast per frame (~0.1ms)"
    },
    "progressIndicator": {
      "renderingMethod": "CSS-based circular progress (GPU accelerated)",
      "updateFrequency": "60fps (requestAnimationFrame)",
      "DOMupdates": "Single element, update transform/stroke-dashoffset only",
      "cost": "Negligible - single DOM style update per frame"
    },
    "timerSystem": {
      "timingMethod": "Timestamp-based (performance.now())",
      "accuracy": "±10ms on modern browsers",
      "noFrameDependency": "Timer progresses based on real time, not frame count",
      "cost": "Negligible - simple timestamp comparison"
    },
    "overallImpact": "< 1% FPS impact (estimated < 0.2ms per frame total)"
  }
}
```

### Memory Management

```json
{
  "memory": {
    "hoverTimerSystem": {
      "size": "~500 bytes (state variables)",
      "lifecycle": "Persistent (created once, reused)",
      "cleanup": "Reset state on hover cancel (no allocations)"
    },
    "progressIndicator": {
      "size": "Single DOM element (~1KB)",
      "lifecycle": "Created once, show/hide as needed",
      "cleanup": "Remove from DOM on simulator destroy"
    },
    "eventListeners": {
      "count": "2-3 (mouse move, click, hover callbacks)",
      "cleanup": "Remove listeners on simulator destroy"
    },
    "totalFootprint": "< 5KB additional memory usage"
  }
}
```

### Browser Compatibility

```json
{
  "compatibility": {
    "minimumRequirements": {
      "performance.now()": "Supported in all modern browsers (Chrome, Firefox, Edge, Safari)",
      "requestAnimationFrame": "Universal support",
      "CSS transforms": "Universal support",
      "SVG or clip-path": "Universal support (fallback to border-radius if needed)"
    },
    "testedBrowsers": [
      "Chrome 90+ (recommended)",
      "Firefox 88+",
      "Edge 90+",
      "Safari 14+ (may need vendor prefixes for some CSS)"
    ],
    "fallbacks": {
      "noPerformanceAPI": "Use Date.now() (less accurate but functional)",
      "noSVG": "Use CSS clip-path or border-radius for circular progress"
    }
  }
}
```

### Code Reusability

```json
{
  "reusability": {
    "hoverTimerSystem": {
      "genericDesign": "Can be reused for any hover-to-trigger interaction",
      "configuration": "Parameterize hover duration (currently hardcoded 500ms)",
      "futureUse": [
        "Hover-to-target enemy ships",
        "Hover-to-show tooltips",
        "Hover-to-activate station docking"
      ]
    },
    "progressIndicator": {
      "genericDesign": "Can be reused for any progress visualization",
      "futureUse": [
        "Mining progress indicator",
        "Warp charge progress",
        "Module activation cooldown"
      ]
    },
    "hoverDetection": {
      "genericDesign": "Raycast-based hover detection can be abstracted",
      "futureUse": [
        "Hover detection for asteroids, stations, anomalies",
        "Context-sensitive cursor changes"
      ]
    }
  }
}
```

## Risk Assessment

```json
{
  "risks": [
    {
      "risk": "Raycasting performance impact on low-end devices",
      "severity": "Medium",
      "likelihood": "Low",
      "mitigation": [
        "Throttle raycasting to every 2-3 frames if FPS < 30",
        "Only raycast when mouse moves (track lastMousePosition)",
        "Use simpler collision detection if raycasting too expensive"
      ]
    },
    {
      "risk": "Progress indicator not visible on certain backgrounds",
      "severity": "Low",
      "likelihood": "Medium",
      "mitigation": [
        "Add semi-transparent dark background behind indicator",
        "Use high-contrast colors (bright cyan/green)",
        "Add subtle glow effect for visibility in bright areas"
      ]
    },
    {
      "risk": "Timer accuracy issues on very low framerates",
      "severity": "Low",
      "likelihood": "Low",
      "mitigation": [
        "Use timestamp-based timing (performance.now()), not frame-based counting",
        "Timer progresses based on real time, unaffected by framerate"
      ]
    },
    {
      "risk": "Conflicts with existing click/hover behaviors",
      "severity": "Medium",
      "likelihood": "Medium",
      "mitigation": [
        "Carefully review existing InputManager click handlers",
        "Ensure hover timer doesn't interfere with ship targeting",
        "Add priority system: HUD hover only triggers if no other interaction active"
      ]
    },
    {
      "risk": "User confusion about new interaction pattern",
      "severity": "Low",
      "likelihood": "High",
      "mitigation": [
        "Progress indicator provides clear visual feedback",
        "Consider adding one-time tooltip: 'Hold cursor over ship to open menu'",
        "Document in help/tutorial section"
      ]
    },
    {
      "risk": "Edge case: Ship destroyed/warps away during hover",
      "severity": "Low",
      "likelihood": "Low",
      "mitigation": [
        "Add ship existence check in HoverTimerSystem.updateHoverProgress()",
        "Automatically cancel timer if target ship no longer exists",
        "Hide progress indicator immediately on ship removal"
      ]
    }
  ]
}
```

## Testing & Validation Strategy

```json
{
  "validation": {
    "manualTesting": {
      "phase": "After Step 9",
      "duration": "1 hour",
      "testCases": [
        "Quick hover (< 500ms) → No HUD",
        "Full hover (500ms) → HUD opens",
        "Interrupted hover → Timer resets",
        "Progress indicator visibility",
        "Rapid hover spam prevention",
        "Click bypass (if implemented)",
        "HUD already open → No progress indicator"
      ]
    },
    "automatedTesting": {
      "phase": "After Step 10",
      "framework": "Puppeteer or Playwright",
      "testFile": "/mnt/c/github/superstarships/tests/test_hover_radial_hud.js",
      "testCases": "8 test cases from test plan (TC-001 to TC-008)",
      "evidenceCapture": "JSON files with timing data, HUD states, progress values",
      "successCriteria": "All 8 tests pass, timing accuracy within ±50ms"
    },
    "performanceTesting": {
      "phase": "After Step 11",
      "tools": "Chrome DevTools Performance Profiler",
      "metrics": [
        "FPS during hover (should remain 60fps)",
        "Raycast execution time (< 0.5ms per frame)",
        "Progress indicator render time (< 0.1ms per frame)",
        "Total overhead (< 1% CPU usage)"
      ]
    },
    "browserAutomation": {
      "workflow": [
        "Step 1: Initialize browser session (POST localhost:8081/browser-init)",
        "Step 2: Navigate to game (POST localhost:8081/browser-navigate to localhost:8080)",
        "Step 3: Wait for game load (evaluate window.simulator exists)",
        "Step 4: Execute test scenarios (mouse hover, timing checks, HUD state queries)",
        "Step 5: Capture evidence (screenshots, console logs, timing data)",
        "Step 6: Validate results (compare against expected behavior)",
        "Step 7: Cleanup (POST localhost:8081/browser-close)"
      ],
      "exampleTestStep": {
        "description": "Test TC-003: HUD opens after 500ms hover",
        "automation": [
          "Evaluate: Get ship canvas position via simulator.ship.position",
          "Mouse move: Position cursor over ship",
          "Wait: 500ms",
          "Evaluate: Check simulator.radialHUD.isVisible() === true",
          "Screenshot: Capture HUD open state",
          "Console logs: Verify no errors during hover"
        ]
      }
    }
  }
}
```

## Implementation Timeline Estimate

```json
{
  "timeline": {
    "totalEstimatedTime": "9-11 hours",
    "breakdown": [
      {"step": 1, "task": "HoverTimerSystem.js", "time": "45 min"},
      {"step": 2, "task": "HoverProgressIndicator.js", "time": "1 hour"},
      {"step": 3, "task": "hover-progress.css", "time": "20 min"},
      {"step": 4, "task": "Ship hover detection", "time": "1 hour"},
      {"step": 5, "task": "Game loop integration", "time": "30 min"},
      {"step": 6, "task": "RadialHUD modification", "time": "45 min"},
      {"step": 7, "task": "Click bypass (optional)", "time": "30 min"},
      {"step": 8, "task": "Update index.html", "time": "5 min"},
      {"step": 9, "task": "Manual testing", "time": "1 hour"},
      {"step": 10, "task": "Automated test script", "time": "2 hours"},
      {"step": 11, "task": "Performance optimization", "time": "45 min"},
      {"step": 12, "task": "Documentation", "time": "30 min"}
    ],
    "recommendedApproach": "Implement Steps 1-8 in single session (5 hours), then test/optimize in separate session (4 hours)"
  }
}
```

## Success Metrics

```json
{
  "successCriteria": {
    "functionalRequirements": [
      "✅ HUD does NOT open on hover < 500ms",
      "✅ HUD opens after exactly 500ms continuous hover",
      "✅ Progress indicator visible during hover",
      "✅ Progress indicator fills from 0% to 100% over 500ms",
      "✅ Timer resets when hover interrupted",
      "✅ No progress indicator when HUD already open",
      "✅ All 8 automated tests pass"
    ],
    "performanceRequirements": [
      "✅ No FPS degradation during hover (maintain 60fps)",
      "✅ Hover detection latency < 50ms",
      "✅ Timer accuracy: 500ms ± 50ms",
      "✅ Progress indicator updates smoothly at 60fps"
    ],
    "userExperienceRequirements": [
      "✅ Progress indicator clearly visible on all backgrounds",
      "✅ Interaction feels responsive and intentional",
      "✅ No accidental HUD opens from quick cursor passes",
      "✅ Click bypass works intuitively (if implemented)"
    ]
  }
}
```

---

## Summary

This implementation plan provides a **modular, testable architecture** for the hover-to-open RadialHUD feature:

**Core Components:**
1. `HoverTimerSystem.js` - Timer logic with 500ms threshold
2. `HoverProgressIndicator.js` - Visual progress feedback (circular fill)
3. Integration with existing `RadialHUD.js` and `SpaceshipSimulator.js`

**Key Technical Decisions:**
- **Timestamp-based timing** (performance.now()) for accurate 500ms detection
- **Raycasting** for ship hover detection (reusable for other interactions)
- **CSS-based visual indicator** (GPU accelerated, minimal performance impact)
- **Observer pattern** for hover completion callbacks

**Testing Strategy:**
- **Manual testing** (Step 9): Validate all acceptance criteria
- **Automated testing** (Step 10): 8 test cases via Puppeteer/Playwright
- **Browser automation** (localhost:8081): Automated validation after implementation
- **Performance profiling** (Step 11): Ensure < 1% FPS impact

**Estimated Timeline:** 9-11 hours total (5 hours implementation, 4 hours testing/optimization)

**Risks Identified:**
- Raycasting performance on low-end devices (mitigated via throttling)
- Progress indicator visibility (mitigated via high-contrast colors + glow)
- Conflicts with existing click behaviors (mitigated via careful integration testing)

DECISION: implementation_plan_ready