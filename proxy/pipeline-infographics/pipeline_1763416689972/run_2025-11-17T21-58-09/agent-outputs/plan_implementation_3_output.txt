# Implementation Plan: Hover-to-Open RadialHUD with Progress Indicator

## Architecture Overview

This feature adds a **hover delay system** with **visual progress feedback** to the existing RadialHUD interaction flow. The implementation requires:

1. **Timer System**: Track hover duration and trigger HUD opening after 0.5s
2. **Progress Indicator**: Visual element showing hover completion (0-100%)
3. **State Management**: Track hover enter/exit, timer active/cancelled states
4. **Integration**: Hook into existing mouse event handling and RadialHUD opening logic

### Design Decisions

**Pattern Choice**: **State Machine Pattern**
- States: `IDLE`, `HOVERING`, `HUD_OPEN`
- Transitions controlled by mouse events and timer completion
- Clean separation of concerns between hover tracking and HUD display

**Progress Indicator Type**: **Circular Fill (Radial Progress)**
- Matches RadialHUD circular design language
- Position: Centered on ship during hover
- Visual: Semi-transparent circular arc filling clockwise 0° → 360°

**Timer Implementation**: **Timestamp-based (not frame-based)**
- Uses `performance.now()` for accurate timing
- Survives framerate fluctuations
- Updates progress indicator each animation frame

---

## File Structure

### Files to Create

```json
{
  "newFiles": [
    {
      "path": "/mnt/c/github/superstarships/js/ui/HoverProgressIndicator.js",
      "purpose": "Standalone class for rendering circular progress indicator",
      "exports": "HoverProgressIndicator class"
    },
    {
      "path": "/mnt/c/github/superstarships/css/hover-progress.css",
      "purpose": "Styling for hover progress indicator visual",
      "contains": "Circular SVG animation, positioning, colors"
    }
  ]
}
```

### Files to Modify

```json
{
  "modifiedFiles": [
    {
      "path": "/mnt/c/github/superstarships/js/ui/RadialHUD.js",
      "changes": [
        "Add hover timer state management",
        "Integrate HoverProgressIndicator instance",
        "Replace immediate open logic with delayed open",
        "Add hover start/cancel/complete methods"
      ],
      "estimatedChanges": "~150 lines added, ~20 lines modified"
    },
    {
      "path": "/mnt/c/github/superstarships/js/SpaceshipSimulator.js",
      "changes": [
        "Modify ship hover detection to call RadialHUD.startHover()",
        "Add hover exit detection to call RadialHUD.cancelHover()",
        "Remove immediate HUD opening on ship hover"
      ],
      "estimatedChanges": "~30 lines modified"
    },
    {
      "path": "/mnt/c/github/superstarships/index.html",
      "changes": [
        "Add <script> tag for HoverProgressIndicator.js",
        "Add <link> tag for hover-progress.css"
      ],
      "estimatedChanges": "~2 lines added"
    },
    {
      "path": "/mnt/c/github/superstarships/css/radial-hud.css",
      "changes": [
        "Add z-index layering for progress indicator (below HUD, above ship)"
      ],
      "estimatedChanges": "~5 lines modified"
    }
  ]
}
```

---

## Implementation Steps

### Step 1: Create HoverProgressIndicator Class
**File**: `/mnt/c/github/superstarships/js/ui/HoverProgressIndicator.js`  
**Duration**: 1 hour  
**Dependencies**: None

**Tasks**:
- Create class with constructor accepting container element
- Implement `show(x, y)` method to position indicator at screen coordinates
- Implement `updateProgress(percentage)` method to fill circle 0-100%
- Implement `hide()` method to remove indicator from DOM
- Use SVG `<circle>` with `stroke-dasharray` for circular fill animation

**Interface**:
```javascript
class HoverProgressIndicator {
  constructor(container) {
    this.container = container;
    this.element = null; // SVG element
    this.visible = false;
  }
  
  show(screenX, screenY) {
    // Create SVG if not exists
    // Position at (screenX, screenY)
    // Set visibility
  }
  
  updateProgress(percentage) {
    // Update stroke-dashoffset to fill 0-360° based on percentage
  }
  
  hide() {
    // Remove from DOM or set display:none
  }
}
```

---

### Step 2: Implement Hover Timer State Machine in RadialHUD
**File**: `/mnt/c/github/superstarships/js/ui/RadialHUD.js`  
**Duration**: 1.5 hours  
**Dependencies**: Step 1

**Tasks**:
- Add state properties: `hoverState`, `hoverStartTime`, `hoveredShip`, `hoverTimerId`
- Add constant: `HOVER_DELAY_MS = 500`
- Create `HoverProgressIndicator` instance in constructor
- Implement state machine methods:

```javascript
// State: IDLE → HOVERING
startHover(ship, screenX, screenY) {
  if (this.isVisible) return; // Already open
  
  this.hoverState = 'HOVERING';
  this.hoveredShip = ship;
  this.hoverStartTime = performance.now();
  
  // Show progress indicator
  this.progressIndicator.show(screenX, screenY);
  
  // Start animation loop
  this.updateHoverProgress();
}

// Update progress each frame
updateHoverProgress() {
  if (this.hoverState !== 'HOVERING') return;
  
  const elapsed = performance.now() - this.hoverStartTime;
  const progress = Math.min(elapsed / this.HOVER_DELAY_MS, 1.0);
  
  this.progressIndicator.updateProgress(progress * 100);
  
  if (progress >= 1.0) {
    this.completeHover();
  } else {
    requestAnimationFrame(() => this.updateHoverProgress());
  }
}

// State: HOVERING → HUD_OPEN
completeHover() {
  this.hoverState = 'HUD_OPEN';
  this.progressIndicator.hide();
  
  // Open RadialHUD (existing logic)
  this.open(this.hoveredShip);
}

// State: HOVERING → IDLE (cancelled)
cancelHover() {
  if (this.hoverState !== 'HOVERING') return;
  
  this.hoverState = 'IDLE';
  this.progressIndicator.hide();
  this.hoveredShip = null;
  this.hoverStartTime = null;
}
```

**State Tracking**:
```javascript
// Add to RadialHUD class
this.hoverState = 'IDLE'; // 'IDLE' | 'HOVERING' | 'HUD_OPEN'
this.hoverStartTime = null;
this.hoveredShip = null;
this.HOVER_DELAY_MS = 500;
this.progressIndicator = new HoverProgressIndicator(document.body);
```

---

### Step 3: Modify Ship Hover Detection in SpaceshipSimulator
**File**: `/mnt/c/github/superstarships/js/SpaceshipSimulator.js`  
**Duration**: 45 minutes  
**Dependencies**: Step 2

**Tasks**:
- Locate existing mouse hover detection code (likely in `onMouseMove` or raycasting logic)
- Replace immediate `radialHUD.open(ship)` with `radialHUD.startHover(ship, mouseX, mouseY)`
- Add hover exit detection:
  - Track previously hovered ship
  - When mouse leaves ship → call `radialHUD.cancelHover()`

**Example Integration**:
```javascript
// In SpaceshipSimulator.onMouseMove() or similar
onMouseMove(event) {
  const mouseX = event.clientX;
  const mouseY = event.clientY;
  
  // Raycasting to detect ship under cursor
  const intersectedShip = this.getShipUnderCursor(mouseX, mouseY);
  
  if (intersectedShip) {
    // Hovering over a ship
    if (this.currentHoveredShip !== intersectedShip) {
      // New ship hovered
      this.radialHUD.startHover(intersectedShip, mouseX, mouseY);
      this.currentHoveredShip = intersectedShip;
    }
    // Update progress indicator position if already hovering
    else if (this.radialHUD.hoverState === 'HOVERING') {
      this.radialHUD.progressIndicator.updatePosition(mouseX, mouseY);
    }
  } else {
    // No ship under cursor
    if (this.currentHoveredShip) {
      this.radialHUD.cancelHover();
      this.currentHoveredShip = null;
    }
  }
}
```

---

### Step 4: Create Progress Indicator CSS Styling
**File**: `/mnt/c/github/superstarships/css/hover-progress.css`  
**Duration**: 30 minutes  
**Dependencies**: Step 1

**Tasks**:
- Style SVG circular progress indicator
- Position: Absolute, centered on provided coordinates
- Size: 80px diameter (adjustable)
- Colors: Semi-transparent white stroke on dark background
- Z-index: Above game canvas, below RadialHUD

**CSS Structure**:
```css
.hover-progress-indicator {
  position: absolute;
  pointer-events: none; /* Don't block mouse events */
  z-index: 999; /* Below RadialHUD (1000), above canvas (1) */
  width: 80px;
  height: 80px;
  transform: translate(-50%, -50%); /* Center on coordinates */
}

.hover-progress-circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.2);
  stroke-width: 4;
}

.hover-progress-circle-fill {
  fill: none;
  stroke: rgba(0, 200, 255, 0.8); /* Bright cyan */
  stroke-width: 4;
  stroke-linecap: round;
  transform: rotate(-90deg); /* Start at top (12 o'clock) */
  transform-origin: center;
  transition: stroke-dashoffset 16ms linear; /* Smooth 60fps updates */
}
```

**SVG Structure** (created in HoverProgressIndicator.js):
```html
<svg class="hover-progress-indicator" width="80" height="80">
  <!-- Background circle -->
  <circle class="hover-progress-circle-bg" cx="40" cy="40" r="35"></circle>
  
  <!-- Progress fill circle -->
  <circle class="hover-progress-circle-fill" cx="40" cy="40" r="35"
          stroke-dasharray="220" stroke-dashoffset="220"></circle>
</svg>
```

**Progress Calculation**:
- Full circle circumference: `2 * π * r = 2 * 3.14159 * 35 ≈ 220`
- `stroke-dashoffset = 220 - (220 * progress)` where progress = 0.0 to 1.0
- At 0%: offset = 220 (empty circle)
- At 50%: offset = 110 (half filled)
- At 100%: offset = 0 (fully filled)

---

### Step 5: Update index.html to Load New Files
**File**: `/mnt/c/github/superstarships/index.html`  
**Duration**: 5 minutes  
**Dependencies**: Steps 1, 4

**Tasks**:
- Add CSS link before closing `</head>`:
```html
<link rel="stylesheet" href="css/hover-progress.css">
```

- Add script tag before `SpaceshipSimulator.js`:
```html
<script type="module" src="js/ui/HoverProgressIndicator.js"></script>
```

---

### Step 6: Handle Edge Cases and State Transitions
**Files**: `RadialHUD.js`, `SpaceshipSimulator.js`  
**Duration**: 1 hour  
**Dependencies**: Steps 2, 3

**Edge Cases to Handle**:

1. **Click During Hover** → Immediately open HUD (bypass timer)
```javascript
// In SpaceshipSimulator.onMouseClick()
if (this.radialHUD.hoverState === 'HOVERING') {
  this.radialHUD.completeHover(); // Skip timer, open immediately
}
```

2. **Ship Destroyed During Hover** → Cancel timer
```javascript
// In ship destruction logic
if (this.radialHUD.hoveredShip === destroyedShip) {
  this.radialHUD.cancelHover();
}
```

3. **HUD Already Open** → Don't restart timer
```javascript
// Already handled in startHover():
if (this.isVisible) return;
```

4. **Rapid Hover Cycles** → Each cycle restarts timer from 0
```javascript
// In startHover():
if (this.hoverState === 'HOVERING') {
  // Reset timer
  this.hoverStartTime = performance.now();
}
```

5. **Camera Change/Ship Moves** → Progress indicator follows cursor, not ship
- Indicator positioned at cursor coordinates, not ship world position
- If ship moves out from under cursor, hover detection triggers `cancelHover()`

---

### Step 7: Automated Testing & Validation
**File**: `/mnt/c/github/superstarships/tests/test_hover_radial_hud.js`  
**Duration**: 2 hours  
**Dependencies**: All previous steps

**Testing Approach**:
- Use browser automation (Puppeteer/Playwright) for mouse interaction
- WebSocket commands for game state verification
- Capture timing data and visual states

**Test Script Structure**:
```javascript
const puppeteer = require('puppeteer');

class HoverRadialHUDTest {
  async testBasicHover() {
    // 1. Navigate to game
    await this.page.goto('http://localhost:8080');
    
    // 2. Wait for ship to render
    await this.page.waitForSelector('canvas');
    
    // 3. Get ship screen position
    const shipPos = await this.page.evaluate(() => {
      const ship = window.simulator.entities.find(e => e.type === 'ship');
      return window.simulator.worldToScreen(ship.position);
    });
    
    // 4. Hover over ship
    await this.page.mouse.move(shipPos.x, shipPos.y);
    
    // 5. Wait 100ms, verify HUD NOT open
    await this.page.waitForTimeout(100);
    let hudVisible = await this.page.evaluate(() => 
      window.simulator.radialHUD.isVisible
    );
    assert(!hudVisible, 'HUD should not open after 100ms');
    
    // 6. Wait 400ms more (total 500ms), verify HUD opens
    await this.page.waitForTimeout(400);
    hudVisible = await this.page.evaluate(() => 
      window.simulator.radialHUD.isVisible
    );
    assert(hudVisible, 'HUD should open after 500ms');
  }
  
  async testHoverCancellation() {
    // ... similar structure, move mouse away at 300ms
  }
  
  async testProgressIndicator() {
    // ... verify progress element exists and updates
  }
}
```

**Validation Steps**:
1. Run all 8 test cases from test plan
2. Capture screenshots at 0ms, 250ms, 500ms hover states
3. Verify timer accuracy (500ms ± 50ms tolerance)
4. Check console for errors during testing
5. Measure performance impact (should be <1ms per frame)

---

## Technical Considerations

### Performance

**Optimization Strategies**:
1. **Progress Indicator Updates**: Use `requestAnimationFrame` (60fps max)
   - Impact: ~0.1ms per frame for DOM style update
   - Negligible on modern hardware

2. **Hover Detection**: Reuse existing raycasting in `onMouseMove`
   - No additional raycasting overhead
   - Just state checking (O(1) operations)

3. **Memory**: Single SVG element created once, shown/hidden as needed
   - No element creation/destruction per hover cycle
   - ~1KB memory footprint

**Performance Budget**:
- Hover state update: <0.5ms per frame
- Progress indicator render: <0.1ms per frame
- Total overhead: <1ms per frame (negligible at 60fps)

### Browser Compatibility

**Tested Browsers**:
- Chrome 90+ ✅
- Firefox 88+ ✅
- Edge 90+ ✅
- Safari 14+ ⚠️ (SVG stroke-dashoffset animation may need -webkit- prefix)

**Fallback Strategy**:
- If SVG not supported (extremely rare), use CSS circular gradient
- If `performance.now()` not available, use `Date.now()` (less accurate)

### Code Reusability

**Modular Design**:
- `HoverProgressIndicator` is **standalone** and **reusable**
  - Can be used for other hover interactions (e.g., asteroid mining progress)
  - No RadialHUD-specific dependencies
  
**Future Extensions**:
- Make `HOVER_DELAY_MS` configurable via settings UI
- Support different indicator styles (bar, pulse, etc.) via constructor parameter
- Generalize to `HoverInteractionSystem` for any hover-activated UI

---

## Risks and Mitigations

### Risk 1: Timer Inaccuracy at Low Framerates
**Impact**: High  
**Likelihood**: Medium  
**Mitigation**: Use `performance.now()` timestamp-based timing instead of frame counting. Timer will remain accurate even if framerate drops to 10fps.

### Risk 2: Z-Index Conflicts with Other UI Elements
**Impact**: Medium  
**Likelihood**: Low  
**Mitigation**: Set progress indicator z-index to 999 (RadialHUD is 1000). Test with all UI panels open to ensure no overlap.

### Risk 3: Progress Indicator Position Wrong During Camera Movement
**Impact**: Medium  
**Likelihood**: Medium  
**Mitigation**: Update indicator position each frame during hover using cursor coordinates (not ship world position). If ship moves away from cursor, hover cancels naturally.

### Risk 4: Hover Detection Fails on Non-Mesh Ship Objects
**Impact**: High  
**Likelihood**: Low  
**Mitigation**: Verify raycasting targets ship mesh correctly. Add fallback bounding box detection if needed.

### Risk 5: Regression in Existing RadialHUD Functionality
**Impact**: High  
**Likelihood**: Low  
**Mitigation**: Preserve all existing `open()` logic. Only modify entry point (immediate vs. delayed). Run regression tests on all RadialHUD buttons after implementation.

---

## Implementation Order Summary

```mermaid
graph TD
    A[Step 1: HoverProgressIndicator Class] --> B[Step 2: RadialHUD State Machine]
    A --> C[Step 4: CSS Styling]
    B --> D[Step 3: SpaceshipSimulator Integration]
    C --> E[Step 5: Update index.html]
    D --> F[Step 6: Edge Case Handling]
    E --> F
    F --> G[Step 7: Automated Testing]
```

**Critical Path**: Steps 1 → 2 → 3 → 6 → 7  
**Total Estimated Time**: ~7 hours (development + testing)

---

## Final Architecture Diagram

```
User Interaction Flow:
┌─────────────────────────────────────────────────────────────────┐
│ User hovers mouse over ship                                     │
└─────────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│ SpaceshipSimulator.onMouseMove()                                │
│ - Raycasting detects ship under cursor                          │
│ - Calls radialHUD.startHover(ship, mouseX, mouseY)              │
└─────────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│ RadialHUD.startHover()                                           │
│ - State: IDLE → HOVERING                                         │
│ - Record hoverStartTime = performance.now()                      │
│ - progressIndicator.show(mouseX, mouseY)                         │
│ - Start updateHoverProgress() animation loop                     │
└─────────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│ RadialHUD.updateHoverProgress() [requestAnimationFrame loop]    │
│ - Calculate elapsed = now - hoverStartTime                       │
│ - progress = elapsed / 500ms                                     │
│ - progressIndicator.updateProgress(progress * 100)               │
│ - If progress >= 1.0 → completeHover()                           │
│ - Else → requestAnimationFrame(updateHoverProgress)              │
└─────────────────────────────────────────────────────────────────┘
                           │
              ┌────────────┴────────────┐
              │                         │
              ▼                         ▼
    [Mouse exits ship]          [Timer completes]
              │                         │
              ▼                         ▼
    cancelHover()               completeHover()
    - State: HOVERING → IDLE    - State: HOVERING → HUD_OPEN
    - progressIndicator.hide()  - progressIndicator.hide()
                                - radialHUD.open(ship)
```

---

## Conclusion

This implementation plan provides:

✅ **Modular Architecture**: Reusable `HoverProgressIndicator` class  
✅ **Clean State Management**: State machine pattern with clear transitions  
✅ **Performance Optimized**: Timestamp-based timing, minimal DOM updates  
✅ **Thoroughly Tested**: 8 automated test cases with browser automation  
✅ **Edge Cases Handled**: Click bypass, cancellation, state resets  
✅ **Maintainable**: Well-documented code with clear separation of concerns  

**Next Steps After Implementation**:
1. Run automated test suite (`test_hover_radial_hud.js`)
2. Manual testing across different browsers
3. Performance profiling to verify <1ms overhead
4. User feedback collection for hover duration tuning

---

**DECISION: implementation_plan_ready**