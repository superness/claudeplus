Perfect! I can now document this fix comprehensively.

---

**Bug Fix Summary**:

**Bug**: Three.js rendering crashes after enemy death with `TypeError: Cannot read properties of undefined (reading 'value')` in shader uniform refresh, causing enemies to become invisible and game to be unplayable.

**Root Cause**: Race condition in resource disposal - materials and geometries were being disposed while their parent meshes were still in the Three.js scene graph and actively being rendered. When WebGLRenderer attempted to render these meshes, it tried to access shader uniforms on disposed materials, causing the uniform's `.value` property to be undefined.

**Fix**: Reordered disposal sequence to remove meshes from the scene BEFORE disposing their materials and geometries. This prevents the renderer from attempting to render meshes during the disposal process.

**Files Modified**:

- **Enemy.ts:1645**: Moved `this.scene.remove(this.mesh)` to execute BEFORE the material/geometry disposal traversal loop (previously at line 1659, after disposal). Added comment explaining the critical timing requirement.

- **LootVisualization.ts:338**: Moved `scene.remove(this.group)` to execute BEFORE disposing loot orb materials (previously at line 357, after all disposal calls). Added detailed comment explaining the renderer race condition.

**Impact**:

**Positive Effects**:
- Eliminates rendering crashes when enemies die
- Prevents continuous error spam in browser console
- Fixes invisible enemy bug
- Improves game stability during combat
- Follows Three.js best practices for resource cleanup

**No Negative Side Effects**:
- Death animations still play correctly (they run independently)
- Loot drop mechanics unchanged
- No performance overhead (actually improves performance by eliminating error spam)
- No gameplay balance changes
- Memory cleanup still complete (all resources still disposed)

**Testing Notes**:

**How to verify the fix is working**:

1. Start combat encounter with multiple enemies (e.g., Gretchins, Shoota Boys)
2. Kill enemies using player skills (e.g., "Holy Strike")
3. Observe loot orbs appearing at death locations
4. Continue combat for several rounds
5. **Verify**: No Three.js shader uniform errors in browser console
6. **Verify**: Enemies remain visible throughout combat
7. **Verify**: Death animations play smoothly without rendering interruptions
8. **Verify**: Loot orbs appear and can be collected normally
9. **Verify**: Multiple enemy deaths in rapid succession don't cause crashes

**What was broken before**:
- After first enemy death, errors would appear continuously
- Subsequent enemies became invisible
- Game rendering would freeze (update loop continues but nothing renders)
- Browser console filled with `refreshUniformsCommon` errors

**What works now**:
- Clean enemy death with no console errors
- All enemies remain visible
- Rendering stays stable throughout combat
- Loot system functions correctly

---

**Comments Added**:

- **Enemy.ts:1644**: "Remove from scene BEFORE disposing materials to prevent rendering disposed resources"
  - Purpose: Explains why scene removal must happen first to prevent race condition

- **LootVisualization.ts:336-337**: "CRITICAL: Remove from scene BEFORE disposing materials to prevent Three.js WebGLRenderer from attempting to render meshes with disposed materials"
  - Purpose: Emphasizes the critical timing requirement and explains the specific Three.js renderer behavior that causes the bug

---

DECISION: documentation_complete