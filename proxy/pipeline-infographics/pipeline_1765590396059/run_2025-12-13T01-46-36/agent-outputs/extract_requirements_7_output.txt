Based on my research, I'll now compile the complete requirements extraction document for the Henchmen/Heroes System, using authentic GW1 mechanics and Space Marine 2 threat tiers (not Darktide as originally stated).

---

# REQUIREMENTS EXTRACTION: Henchmen/Heroes System

## Feature Overview

The Henchmen/Heroes System provides AI-controlled squad companions for the Warhammer 40K MMO, directly adapted from Guild Wars 1's proven companion system. This enables solo and small-group players to experience full tactical combat while maintaining the 40K squad fantasy.

---

## REQUIREMENTS FROM DESIGN DOCS

### Existing Foundation (from design-docs/)

**Party System (api-specification.md, systems-integration.md):**
- Maximum party size: 4 players for standard content
- PvE party configurations: 2, 4, 6, 8, or 12 characters total (matching GW1)
- Empty player slots can be filled with Henchmen or Heroes

**Class System (progression-design.md):**
- 12 classes across 3 factions (Imperial, Tau, Ork)
- Each class has access to 50+ skills, selects 8 for skill bar + 1 elite
- Secondary profession system after level 10
- Level cap: 30

**Summon Limits (combat-design.md):**
- Maximum 2 active constructs/summons per player
- Henchmen/Heroes are SEPARATE from summon limits (they are party members, not summons)

---

## REQUIREMENTS FROM GUILD WARS 1 RESEARCH

### Henchmen System (Authentic GW1 Mechanics)

**Definition:** Fixed AI companions available at outposts/mission hubs with preset builds.

| Specification | GW1 Authentic Value | 40K Adaptation |
|---------------|---------------------|----------------|
| Skill Customization | None - fixed skills based on profession | None - fixed loadout per henchman type |
| Attribute Customization | None - fixed attributes | None - preset builds |
| Equipment Customization | None - fixed gear | None - standardized faction gear |
| Level | Matches outpost/zone level | Matches mission difficulty level |
| Cost to Acquire | Free | Free (unlocked via story progression) |
| Movement Speed | 104% of player speed | 104% of player speed |
| Positioning Control | None in original GW1 | None |
| Death Penalty | Takes full death penalty | Takes appropriate penalty per design |

**Henchman Archetypes per Faction (12 total, 4 per faction):**

*Imperial:*
1. **Guardsman** - Ranged DPS, fixed lasgun build
2. **Medicae** - Healer, fixed support build
3. **Ogryn** - Tank, fixed melee/taunt build
4. **Psyker Adept** - Caster DPS, fixed psychic build

*Tau:*
1. **Fire Warrior** - Ranged DPS, fixed pulse rifle build
2. **Earth Caste Medic** - Healer, fixed drone-support build
3. **Crisis Suit Pilot** - Tank, fixed battlesuit build
4. **Ethereal Acolyte** - Support/Buffer, fixed aura build

*Ork:*
1. **Shoota Boy** - Ranged DPS, fixed dakka build
2. **Painboy Assistant** - Healer, fixed brutal healing build
3. **'Ard Boy** - Tank, fixed heavy armor melee build
4. **Weirdboy Grot** - Caster DPS, fixed WAAAGH! magic build

---

### Heroes System (Authentic GW1 Mechanics)

**Definition:** Fully customizable AI companions that players unlock and develop.

| Specification | GW1 Authentic Value | 40K Adaptation |
|---------------|---------------------|----------------|
| Skill Customization | Full - any unlocked skill from account pool | Full - any skill unlocked for that class |
| Attribute Customization | Full - player allocates attribute points | Full - player allocates attribute points |
| Equipment Customization | Weapons: manual. Armor: auto-scales to level | Weapons: manual. Armor: auto-scales |
| Level | Matches player level | Matches player level |
| Cost to Acquire | Story unlock or special acquisition | Story unlock, reputation, or requisition |
| Movement Speed | 104% of player speed | 104% of player speed |
| Positioning Control | Flag system for precise placement | Flag system for tactical positioning |
| Combat Stance | Passive / Attack / Guard | Passive / Attack / Guard |
| Skill Suppression | Can disable specific skills | Can disable specific skills |

**Hero Attribute Points (GW1 Authentic):**
- Heroes gain attribute points at the same rate as players
- Heroes receive +15 bonus attribute points at level 10
- Heroes receive +15 bonus attribute points at level 15
- Total at level 30: Standard allocation + 30 bonus points

**Hero Combat Stances:**
1. **Attack** - Aggressively engages enemies, uses skills freely
2. **Guard** - Defends position, only attacks threats to self or flagged allies
3. **Passive** - Does not attack, only uses defensive/healing skills

**Hero Flag System:**
- Players can place positioning flags on the battlefield
- Heroes move to and hold flagged positions
- Flags can be set per-hero or as group command
- Clear flag returns hero to follow behavior

---

## REQUIREMENTS FROM SPACE MARINE 2 RESEARCH

### Enemy Threat Tier System

**Critical Clarification:** The minoris/majoris/extremis/terminus system is from **Warhammer 40,000: Space Marine 2**, NOT Darktide. Darktide uses armor-type classifications (Flak, Unarmored, Carapace, Maniacs, Unyielding, Infested).

| Threat Tier | SM2 Definition | Visual Indicator | Spawn Pattern |
|-------------|----------------|------------------|---------------|
| **Minoris** | Weakest enemies, instantly killed on parry | White indicator | Large packs (10-20+) |
| **Majoris** | Player-sized, significantly tougher | Blue indicator | Small groups (3-6) |
| **Extremis** | Miniboss units, appear in kill feed | Yellow indicator | Solo or pairs |
| **Terminus** | Full boss units with health bars | Purple indicator | Solo, scripted encounters |

**Space Marine 2 Threat Tier Behaviors:**
- **Minoris:** Can be cleaved through, exist to make players feel powerful
- **Majoris:** Require focused attention, can call reinforcements, varied attack patterns
- **Extremis:** Require tactical approach, have unique mechanics, execution animations on kill
- **Terminus:** Phase-based fights, visible health bars, encounter-defining mechanics

---

## INTEGRATION WITH EXISTING SYSTEMS

### Party Composition Rules

```
Maximum Party Size: 4-12 (based on content type)

Composition Options:
- 4-player content: Up to 3 Henchmen/Heroes if solo
- 8-player content: Up to 7 Henchmen/Heroes if solo
- 12-player content: Up to 11 Henchmen/Heroes if solo

Restrictions:
- Heroes limited to 3 per player in party
- Henchmen have no limit beyond party size
- PvP: Heroes allowed in specific formats only
- Competitive PvP: No Henchmen/Heroes
```

### Hero Skill Access

Heroes can use:
- Any skill the player has unlocked for that hero's class
- Skills from secondary profession if hero has one assigned
- Elite skills if player has captured them for that class

Heroes cannot use:
- Player-specific skills (e.g., leadership rallies that require player input)
- PvP-only skills in PvE contexts

### Faction-Locked Heroes

- Imperial heroes only available to Imperial players
- Tau heroes only available to Tau players  
- Ork heroes only available to Ork players
- Cross-faction heroes: Special story unlocks (e.g., defector characters)

---

## DATA MODEL ADDITIONS

### New Tables Required

```sql
-- Henchman definitions (static game data)
CREATE TABLE henchmen (
    id UUID PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    faction_id UUID REFERENCES factions(id),
    class_id UUID REFERENCES classes(id),
    description TEXT,
    unlock_requirement JSONB, -- story progress, reputation, etc.
    fixed_skill_bar UUID[], -- 8 skill references
    fixed_attributes JSONB, -- attribute allocations
    created_at TIMESTAMP DEFAULT NOW()
);

-- Hero definitions (player-owned, customizable)
CREATE TABLE player_heroes (
    id UUID PRIMARY KEY,
    player_id UUID REFERENCES players(id),
    hero_template_id UUID REFERENCES hero_templates(id),
    name VARCHAR(100) NOT NULL,
    level INTEGER DEFAULT 1,
    experience BIGINT DEFAULT 0,
    class_id UUID REFERENCES classes(id),
    secondary_class_id UUID REFERENCES classes(id),
    skill_bar UUID[], -- 8 regular + 1 elite
    disabled_skills UUID[], -- suppressed skills
    attributes JSONB, -- allocated points
    equipment JSONB, -- weapon slots
    combat_stance VARCHAR(20) DEFAULT 'attack', -- passive/attack/guard
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Hero templates (unlockable hero characters)
CREATE TABLE hero_templates (
    id UUID PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    faction_id UUID REFERENCES factions(id),
    class_id UUID REFERENCES classes(id),
    backstory TEXT,
    unlock_requirement JSONB,
    portrait_asset VARCHAR(255),
    model_asset VARCHAR(255),
    voice_set VARCHAR(100),
    created_at TIMESTAMP DEFAULT NOW()
);

-- Enemy threat tier classification
ALTER TABLE enemy_templates ADD COLUMN threat_tier VARCHAR(20) 
    CHECK (threat_tier IN ('minoris', 'majoris', 'extremis', 'terminus'));
```

---

## API ENDPOINTS REQUIRED

### Henchmen Endpoints

```
GET /api/v1/henchmen
  - Returns available henchmen for player's faction and current zone
  - Query params: zone_id, faction_id

GET /api/v1/henchmen/:id
  - Returns specific henchman details including fixed build
```

### Hero Endpoints

```
GET /api/v1/heroes
  - Returns all heroes owned by authenticated player

GET /api/v1/heroes/:id
  - Returns specific hero with full customization details

POST /api/v1/heroes/:id/skills
  - Update hero's skill bar
  - Body: { skill_bar: UUID[], elite_skill: UUID }

POST /api/v1/heroes/:id/attributes
  - Update hero's attribute allocation
  - Body: { attributes: { strength: number, ... } }

POST /api/v1/heroes/:id/equipment
  - Equip weapon to hero
  - Body: { slot: string, item_id: UUID }

POST /api/v1/heroes/:id/stance
  - Set combat stance
  - Body: { stance: 'passive' | 'attack' | 'guard' }

POST /api/v1/heroes/:id/disable-skill
  - Toggle skill suppression
  - Body: { skill_id: UUID, disabled: boolean }
```

### Party Composition Endpoints

```
POST /api/v1/party/add-henchman
  - Add henchman to party
  - Body: { henchman_id: UUID }

POST /api/v1/party/add-hero
  - Add hero to party
  - Body: { hero_id: UUID }

POST /api/v1/party/remove-companion
  - Remove henchman or hero from party
  - Body: { companion_id: UUID, type: 'henchman' | 'hero' }

POST /api/v1/party/flag
  - Set positioning flag for hero(es)
  - Body: { hero_ids: UUID[], position: { x, y, z } }

POST /api/v1/party/clear-flags
  - Clear all positioning flags
```

---

## WEBSOCKET COMBAT INTEGRATION

### New Message Types

```typescript
// Client -> Server
interface HeroCommand {
    type: 'hero_command';
    hero_id: string;
    command: 'move' | 'attack' | 'use_skill' | 'stance' | 'flag';
    target_id?: string;
    position?: { x: number; y: number; z: number };
    skill_id?: string;
    stance?: 'passive' | 'attack' | 'guard';
}

// Server -> Client
interface CompanionStateUpdate {
    type: 'companion_state';
    companions: Array<{
        id: string;
        type: 'henchman' | 'hero';
        health: number;
        max_health: number;
        position: { x: number; y: number; z: number };
        current_target?: string;
        stance: string;
        active_effects: string[];
        skill_cooldowns: Record<string, number>;
    }>;
}

interface CompanionAction {
    type: 'companion_action';
    companion_id: string;
    action: 'skill_use' | 'attack' | 'move' | 'death' | 'resurrect';
    skill_id?: string;
    target_id?: string;
    damage?: number;
    healing?: number;
}
```

---

## AI BEHAVIOR SPECIFICATIONS

### Henchman AI (Simple)

```
Priority Order:
1. Self-preservation (flee at <20% health if healer available)
2. Heal allies (if healer class)
3. Protect low-health allies (if tank class)
4. Attack player's target
5. Attack nearest threat
6. Follow player

Restrictions:
- No skill timing optimization
- No combo awareness
- Basic threat assessment only
```

### Hero AI (Advanced)

```
Priority Order (modified by stance):

ATTACK Stance:
1. Use elite skill when high-value target available
2. Maintain buffs/preparations
3. Attack flagged target or player's target
4. Use AoE on grouped enemies
5. Attack nearest threat
6. Move to flagged position or follow player

GUARD Stance:
1. Heal/protect flagged ally or lowest-health ally
2. Interrupt dangerous enemy skills
3. Only attack threats to guarded targets
4. Maintain defensive position

PASSIVE Stance:
1. Heal allies only
2. Apply defensive buffs
3. Do not attack under any circumstances
4. Follow player or hold position

Advanced Behaviors:
- Skill combo awareness (set up and follow through)
- Energy/resource management
- Interrupt priority targets
- Positioning for AoE effectiveness
- Avoid AoE damage zones
```

---

## IMPLEMENTATION CHECKLIST

### Phase 1: Data Layer
- [ ] Create `henchmen` table with migration
- [ ] Create `hero_templates` table with migration
- [ ] Create `player_heroes` table with migration
- [ ] Add `threat_tier` column to `enemy_templates`
- [ ] Create Henchman repository
- [ ] Create Hero repository
- [ ] Seed initial henchmen (4 per faction = 12 total)
- [ ] Seed initial hero templates (4 per faction = 12 total)

### Phase 2: Service Layer
- [ ] Create HenchmanService with getAvailableHenchmen(), getHenchmanById()
- [ ] Create HeroService with full CRUD operations
- [ ] Create HeroCustomizationService for skill/attribute/equipment management
- [ ] Extend PartyService to handle henchman/hero additions
- [ ] Create CompanionAIService for behavior processing

### Phase 3: API Layer
- [ ] Implement henchmen endpoints (GET list, GET by ID)
- [ ] Implement hero endpoints (full CRUD + customization)
- [ ] Implement party composition endpoints
- [ ] Add validation schemas for all new endpoints
- [ ] Add hero ownership middleware

### Phase 4: WebSocket Integration
- [ ] Add HeroCommand message handler
- [ ] Add CompanionStateUpdate broadcast
- [ ] Add CompanionAction broadcast
- [ ] Integrate companion AI into combat tick
- [ ] Implement flag system for positioning

### Phase 5: AI Implementation
- [ ] Implement basic henchman AI behavior tree
- [ ] Implement advanced hero AI with stance awareness
- [ ] Add skill combo detection and execution
- [ ] Add threat assessment and target prioritization
- [ ] Add positioning and movement AI

### Phase 6: Testing
- [ ] Unit tests for Henchman/Hero services
- [ ] Integration tests for API endpoints
- [ ] WebSocket integration tests for combat scenarios
- [ ] AI behavior tests for each stance
- [ ] Party composition validation tests

---

## VALIDATION RULES

### Hero Customization Validation
- Skill bar must contain exactly 8 skills + 1 elite (or empty slots)
- All skills must be unlocked by player for hero's class
- Secondary class skills only valid if secondary profession assigned
- Attribute points cannot exceed level-based maximum + bonuses
- Equipment must match hero's class proficiency

### Party Composition Validation
- Total companions â‰¤ (max party size - human players)
- Maximum 3 heroes per player in party
- Henchmen must be available in current zone
- No duplicate heroes (same hero template twice)

---

## OPEN DESIGN DECISIONS

The following require design team input before implementation:

1. **Hero Acquisition:** GW1 uses story unlocks. Options for 40K:
   - Story progression unlocks
   - Faction reputation thresholds
   - Requisition currency purchase
   - Achievement unlocks

2. **Cross-Faction Heroes:** Should defector/mercenary heroes exist?
   - Lore-friendly options (Rogue Traders, Kroot mercenaries)
   - Keep strictly faction-locked for purity

3. **Hero Death Penalty:** GW1 heroes take full death penalty. Options:
   - Full penalty (authentic)
   - Reduced penalty (more forgiving)
   - No penalty (heroes are expendable)

4. **Henchman Availability:** Which henchmen appear where?
   - Zone-based (GW1 authentic)
   - Always available once unlocked
   - Story-gated availability

---

**DECISION: requirements_extracted**