<!DOCTYPE html>
<html>
<head>
    <title>Test CEREBRO Reconnection</title>
</head>
<body>
    <h1>üß† CEREBRO Reconnection Test</h1>
    <button onclick="testConnection()">Test Connection</button>
    <button onclick="checkPipelines()">Check Active Pipelines</button>
    <button onclick="reconnectToCerebro()">Reconnect to CEREBRO</button>
    
    <div id="output" style="margin-top: 20px; font-family: monospace; white-space: pre-wrap;"></div>
    
    <script>
        function log(message) {
            const output = document.getElementById('output');
            output.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
            console.log(message);
        }
        
        function testConnection() {
            log('üß™ Testing connection to proxy...');
            const ws = new WebSocket('ws://localhost:8081');
            
            ws.onopen = () => {
                log('‚úÖ Connected to proxy');
                ws.close();
            };
            
            ws.onerror = (error) => {
                log('‚ùå Connection failed: ' + error);
            };
            
            ws.onclose = () => {
                log('üîå Connection closed');
            };
        }
        
        function checkPipelines() {
            log('üîç Checking for active pipelines...');
            const ws = new WebSocket('ws://localhost:8081');
            
            ws.onopen = () => {
                log('‚úÖ Connected, sending check-active-pipelines request');
                ws.send(JSON.stringify({
                    type: 'check-active-pipelines'
                }));
            };
            
            ws.onmessage = (event) => {
                try {
                    const response = JSON.parse(event.data);
                    log('üì• Received: ' + JSON.stringify(response, null, 2));
                    
                    if (response.type === 'active-pipelines') {
                        log('üîÑ Found ' + response.pipelines.length + ' active pipeline(s)');
                        if (response.pipelines.length > 0) {
                            response.pipelines.forEach(pipeline => {
                                log('üìä ' + pipeline.id + ': ' + pipeline.name + ' (' + pipeline.status + ')');
                            });
                        }
                    }
                } catch (error) {
                    log('‚ùå Error parsing response: ' + error);
                }
                ws.close();
            };
            
            ws.onerror = (error) => {
                log('‚ùå WebSocket error: ' + error);
            };
        }
        
        function reconnectToCerebro() {
            log('üß† Attempting to reconnect to CEREBRO...');
            const ws = new WebSocket('ws://localhost:8081');
            
            ws.onopen = () => {
                log('‚úÖ Connected, sending reconnect request');
                ws.send(JSON.stringify({
                    type: 'reconnect-pipeline',
                    pipelineId: 'cerebro-meta-pipeline-v1'
                }));
            };
            
            ws.onmessage = (event) => {
                try {
                    const response = JSON.parse(event.data);
                    log('üì• Reconnect response: ' + JSON.stringify(response, null, 2));
                    
                    if (response.type === 'pipeline-reconnected') {
                        log('üéâ Successfully reconnected to CEREBRO!');
                        if (response.chatHistory) {
                            log('üí¨ Chat history contains ' + response.chatHistory.length + ' messages');
                        }
                    } else if (response.type === 'pipeline-reconnect-failed') {
                        log('‚ùå Reconnection failed: ' + response.error);
                    }
                } catch (error) {
                    log('‚ùå Error parsing reconnect response: ' + error);
                }
                ws.close();
            };
            
            ws.onerror = (error) => {
                log('‚ùå Reconnect WebSocket error: ' + error);
            };
        }
    </script>
</body>
</html>