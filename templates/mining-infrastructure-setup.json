{
  "id": "mining-infrastructure-setup",
  "name": "Mining Infrastructure Setup",
  "description": "Complete setup of mining environment from scratch based on section 3.1: daemon, pool server, and miner with all connections validated",
  "version": "2.0.0",
  "category": "infrastructure",
  "stages": [
    {
      "id": "verify_dependencies",
      "name": "Verify Dependencies",
      "agent": "config_generator",
      "description": "Check that bitcoind, CoiniumServ, and miner software are installed and accessible",
      "decisions": [
        {"choice": "dependencies_ok", "description": "All required software found and verified"},
        {"choice": "missing_dependencies", "description": "Required software missing or not accessible"}
      ]
    },
    {
      "id": "install_dependencies",
      "name": "Install Dependencies",
      "agent": "dependency_installer",
      "description": "Install missing dependencies: Bitcoin Core, Mono Runtime, and cpuminer",
      "inputs": ["verify_dependencies"],
      "decisions": [
        {"choice": "all_dependencies_installed", "description": "All dependencies installed and verified successfully"},
        {"choice": "installation_failed", "description": "Failed to install one or more dependencies"}
      ]
    },
    {
      "id": "generate_configs",
      "name": "Generate Configurations",
      "agent": "config_generator",
      "description": "Create all configuration files: bitcoin.conf, pool config.json, miner settings",
      "inputs": ["verify_dependencies", "install_dependencies"],
      "decisions": [
        {"choice": "configs_generated", "description": "All configuration files created successfully"},
        {"choice": "config_generation_failed", "description": "Failed to generate one or more configuration files"}
      ]
    },
    {
      "id": "start_daemon",
      "name": "Start Bitcoin Daemon",
      "agent": "bitcoin_daemon_manager",
      "description": "Launch bitcoind in regtest mode with generated configuration",
      "inputs": ["generate_configs"],
      "decisions": [
        {"choice": "daemon_started", "description": "Daemon running and RPC responding"},
        {"choice": "daemon_failed", "description": "Daemon failed to start or RPC not responding"}
      ]
    },
    {
      "id": "fund_wallet",
      "name": "Fund Wallet",
      "agent": "wallet_manager",
      "description": "Generate 101 blocks to create mature coinbase rewards and create funded wallet",
      "inputs": ["start_daemon"],
      "decisions": [
        {"choice": "wallet_funded", "description": "Wallet created and funded with mature coins"},
        {"choice": "funding_failed", "description": "Failed to generate blocks or fund wallet"}
      ]
    },
    {
      "id": "start_pool",
      "name": "Start Pool Server",
      "agent": "pool_server_manager",
      "description": "Launch CoiniumServ pool server with daemon connection configuration",
      "inputs": ["fund_wallet"],
      "decisions": [
        {"choice": "pool_started", "description": "Pool server running and stratum listening"},
        {"choice": "pool_failed", "description": "Pool failed to start or stratum not listening"}
      ]
    },
    {
      "id": "verify_pool_daemon",
      "name": "Verify Pool-Daemon Connection",
      "agent": "daemon_pool_connector",
      "description": "Test RPC connection between pool and daemon, verify getblocktemplate works",
      "inputs": ["start_pool"],
      "decisions": [
        {"choice": "connection_verified", "description": "Pool successfully communicating with daemon"},
        {"choice": "connection_failed", "description": "RPC connection not working"}
      ]
    },
    {
      "id": "recover_infrastructure",
      "name": "Recover Infrastructure",
      "agent": "error_recovery_agent",
      "description": "Detect and fix infrastructure issues (Stratum port, RPC failures, process crashes)",
      "inputs": ["verify_pool_daemon", "start_daemon", "start_pool"],
      "decisions": [
        {"choice": "recovery_successful", "description": "Infrastructure recovered and operational"},
        {"choice": "recovery_failed", "description": "Recovery failed after max attempts, escalation required"},
        {"choice": "environment_reset", "description": "Full environment reset completed"},
        {"choice": "error", "description": "Cannot perform recovery operations"}
      ]
    },
    {
      "id": "configure_miner",
      "name": "Configure Miner",
      "agent": "miner_manager",
      "description": "Set up mining software with pool connection and wallet address",
      "inputs": ["verify_pool_daemon"],
      "decisions": [
        {"choice": "miner_configured", "description": "Miner configured and ready to start"},
        {"choice": "miner_config_failed", "description": "Failed to configure miner settings"}
      ]
    },
    {
      "id": "infrastructure_ready",
      "name": "Infrastructure Ready",
      "agent": "cycle_integration_tester",
      "description": "Final validation that all infrastructure components are operational and connected",
      "inputs": ["configure_miner"],
      "decisions": [
        {"choice": "complete", "description": "Complete infrastructure operational and validated"},
        {"choice": "validation_failed", "description": "Final validation detected issues"}
      ]
    }
  ],
  "flow": {
    "type": "self-healing",
    "description": "Self-healing infrastructure setup with automatic error recovery loops for all critical stages",
    "connections": [
      {
        "from": "verify_dependencies",
        "to": "generate_configs",
        "condition": "dependencies_ok",
        "description": "Dependencies verified, proceed to generate configs"
      },
      {
        "from": "verify_dependencies",
        "to": "install_dependencies",
        "condition": "missing_dependencies",
        "description": "Missing dependencies detected, install them"
      },
      {
        "from": "install_dependencies",
        "to": "generate_configs",
        "condition": "all_dependencies_installed",
        "description": "Dependencies installed successfully, proceed to generate configs"
      },
      {
        "from": "install_dependencies",
        "to": "recover_infrastructure",
        "condition": "installation_failed",
        "description": "Dependency installation failed - ROUTE TO RECOVERY"
      },
      {
        "from": "generate_configs",
        "to": "start_daemon",
        "condition": "configs_generated",
        "description": "Configs ready, start daemon"
      },
      {
        "from": "generate_configs",
        "to": "recover_infrastructure",
        "condition": "config_generation_failed",
        "description": "Config generation failed - ROUTE TO RECOVERY"
      },
      {
        "from": "start_daemon",
        "to": "fund_wallet",
        "condition": "daemon_started",
        "description": "Daemon running, fund wallet"
      },
      {
        "from": "start_daemon",
        "to": "recover_infrastructure",
        "condition": "daemon_failed",
        "description": "Daemon failed to start - ROUTE TO RECOVERY"
      },
      {
        "from": "fund_wallet",
        "to": "start_pool",
        "condition": "wallet_funded",
        "description": "Wallet funded, start pool server"
      },
      {
        "from": "fund_wallet",
        "to": "recover_infrastructure",
        "condition": "funding_failed",
        "description": "Wallet funding failed - ROUTE TO RECOVERY"
      },
      {
        "from": "start_pool",
        "to": "verify_pool_daemon",
        "condition": "pool_started",
        "description": "Pool running, verify daemon connection"
      },
      {
        "from": "start_pool",
        "to": "recover_infrastructure",
        "condition": "pool_failed",
        "description": "Pool failed to start - ROUTE TO RECOVERY"
      },
      {
        "from": "verify_pool_daemon",
        "to": "configure_miner",
        "condition": "connection_verified",
        "description": "Pool-daemon connected, configure miner"
      },
      {
        "from": "verify_pool_daemon",
        "to": "recover_infrastructure",
        "condition": "connection_failed",
        "description": "RPC connection failed - ROUTE TO RECOVERY"
      },
      {
        "from": "recover_infrastructure",
        "to": "start_daemon",
        "condition": "recovery_successful",
        "description": "RECOVERY LOOP: Recovery successful, retry from daemon start"
      },
      {
        "from": "recover_infrastructure",
        "to": "start_daemon",
        "condition": "environment_reset",
        "description": "RECOVERY LOOP: Full reset completed, retry from daemon start"
      },
      {
        "from": "recover_infrastructure",
        "to": null,
        "condition": "recovery_failed",
        "description": "Recovery failed after max attempts - ESCALATE AND END"
      },
      {
        "from": "recover_infrastructure",
        "to": null,
        "condition": "error",
        "description": "Cannot perform recovery operations - ESCALATE AND END"
      },
      {
        "from": "configure_miner",
        "to": "infrastructure_ready",
        "condition": "miner_configured",
        "description": "Miner configured, perform final validation"
      },
      {
        "from": "configure_miner",
        "to": "recover_infrastructure",
        "condition": "miner_config_failed",
        "description": "Miner configuration failed - ROUTE TO RECOVERY"
      },
      {
        "from": "infrastructure_ready",
        "to": null,
        "condition": "complete",
        "description": "Infrastructure ready - PIPELINE SUCCESS"
      },
      {
        "from": "infrastructure_ready",
        "to": "recover_infrastructure",
        "condition": "validation_failed",
        "description": "Final validation failed - ROUTE TO RECOVERY"
      }
    ]
  },
  "metadata": {
    "tags": ["infrastructure", "setup", "daemon", "pool", "miner", "mining-cycle", "auto-install"],
    "author": "Mining Cycle Automation System",
    "estimatedTime": "10-15 minutes (including dependency installation)",
    "requiresWSL": true,
    "requiresSudo": true,
    "basedOn": "Section 3.1 of MINING_CYCLE_AUTOMATION_PLAN.md",
    "refactored": "2025-01-22 - Removed type fields, corrected agent assignments",
    "updated": "2025-01-22 - Added automatic dependency installation stage"
  }
}
