<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pipeline Infographic Viewer</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      height: 100vh;
      overflow: hidden;
    }
    .viewer-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    .header {
      background: white;
      padding: 20px 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 {
      font-size: 1.8em;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .controls {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    .select-wrapper {
      position: relative;
    }
    select {
      padding: 10px 40px 10px 15px;
      border: 2px solid #667eea;
      border-radius: 8px;
      font-size: 1em;
      background: white;
      cursor: pointer;
      appearance: none;
      min-width: 300px;
    }
    .select-wrapper::after {
      content: '‚ñº';
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      color: #667eea;
    }
    button {
      padding: 10px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      cursor: pointer;
      font-weight: bold;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    button:active {
      transform: translateY(0);
    }
    .auto-refresh {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9em;
      color: #333;
    }
    .auto-refresh input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    .iframe-container {
      flex: 1;
      background: white;
      margin: 20px;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      overflow: hidden;
    }
    iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    .no-selection {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #999;
      font-size: 1.2em;
    }
    .no-selection svg {
      width: 150px;
      height: 150px;
      margin-bottom: 20px;
      opacity: 0.3;
    }
    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
    }
    .status-running { background: #ffc107; animation: pulse 1.5s infinite; }
    .status-completed { background: #28a745; }
    .status-error { background: #dc3545; }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
  </style>
</head>
<body>
  <div class="viewer-container">
    <div class="header">
      <h1>üìä Pipeline Infographic Viewer</h1>
      <div class="controls">
        <div class="select-wrapper">
          <select id="pipelineSelect">
            <option value="">Select a pipeline...</option>
          </select>
        </div>
        <div class="select-wrapper" id="runSelectWrapper" style="display: none;">
          <select id="runSelect">
            <option value="">Select a run...</option>
          </select>
        </div>
        <button id="viewIndexBtn" style="display: none;">üìã View All Runs</button>
        <button id="refreshBtn">üîÑ Refresh</button>
        <div class="auto-refresh">
          <input type="checkbox" id="autoRefresh" checked>
          <label for="autoRefresh">Auto-refresh (2s)</label>
        </div>
        <button id="openInBrowser">üåê Open in Browser</button>
      </div>
    </div>
    <div class="iframe-container">
      <div id="noSelection" class="no-selection">
        <svg viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="100" cy="100" r="80" stroke="currentColor" stroke-width="4"/>
          <path d="M60 100 L90 130 L140 70" stroke="currentColor" stroke-width="8" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <div>Select a pipeline to view its infographic</div>
      </div>
      <iframe id="infographicFrame" style="display: none;"></iframe>
    </div>
  </div>

  <script>
    const pipelineSelect = document.getElementById('pipelineSelect');
    const runSelect = document.getElementById('runSelect');
    const runSelectWrapper = document.getElementById('runSelectWrapper');
    const viewIndexBtn = document.getElementById('viewIndexBtn');
    const infographicFrame = document.getElementById('infographicFrame');
    const noSelection = document.getElementById('noSelection');
    const refreshBtn = document.getElementById('refreshBtn');
    const autoRefreshCheckbox = document.getElementById('autoRefresh');
    const openInBrowserBtn = document.getElementById('openInBrowser');

    let autoRefreshInterval = null;
    let currentInfographicPath = null;
    let currentIndexPath = null;
    let pipelinesData = [];

    // Load available pipelines
    async function loadPipelines() {
      try {
        const response = await fetch('http://localhost:8081/list-infographics');
        const data = await response.json();

        pipelinesData = data.infographics;
        pipelineSelect.innerHTML = '<option value="">Select a pipeline...</option>';

        data.infographics.forEach(infographic => {
          const option = document.createElement('option');
          option.value = infographic.id;
          option.textContent = `${infographic.name} (${infographic.totalRuns} runs, ${infographic.status})`;
          option.dataset.status = infographic.status;
          pipelineSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading pipelines:', error);
      }
    }

    // Load runs for selected pipeline
    function loadRuns(pipelineId) {
      const pipeline = pipelinesData.find(p => p.id === pipelineId);
      if (!pipeline) return;

      runSelect.innerHTML = '<option value="">Latest run</option>';
      currentIndexPath = pipeline.indexPath;

      pipeline.runs.forEach((run, index) => {
        const option = document.createElement('option');
        option.value = run.path;
        const date = new Date(run.modified);
        option.textContent = `Run ${pipeline.runs.length - index}: ${run.timestamp.replace('T', ' ')}`;
        runSelect.appendChild(option);
      });

      // Show run selector and index button
      runSelectWrapper.style.display = 'block';
      viewIndexBtn.style.display = pipeline.indexPath ? 'block' : 'none';

      // Auto-select latest run
      displayInfographic(pipeline.latestRunPath);
    }

    // Display selected infographic
    function displayInfographic(path) {
      console.log('[displayInfographic] Called with path:', path);

      if (!path) {
        infographicFrame.style.display = 'none';
        noSelection.style.display = 'flex';
        currentInfographicPath = null;
        return;
      }

      // Convert file:// paths to localhost URLs for iframe
      let iframeSrc = path;
      if (path.startsWith('file:///mnt/c/')) {
        // Convert file:///mnt/c/github/claudeplus/... to http://localhost:3005/...
        // Server is running from /mnt/c/github/claudeplus, so make path relative
        iframeSrc = 'http://localhost:3005/' + path.replace('file:///mnt/c/github/claudeplus/', '');
        console.log('[displayInfographic] Converted file:// to localhost:', iframeSrc);
      }

      // Store the clean path (without query params) for opening in browser
      currentInfographicPath = path.split('?')[0];
      console.log('[displayInfographic] Stored currentInfographicPath:', currentInfographicPath);

      infographicFrame.src = iframeSrc + '?t=' + Date.now(); // Cache bust
      console.log('[displayInfographic] Set iframe src to:', infographicFrame.src);
      infographicFrame.style.display = 'block';
      noSelection.style.display = 'none';
    }

    // Refresh current infographic
    function refreshInfographic() {
      if (currentInfographicPath) {
        let iframeSrc = currentInfographicPath;
        if (currentInfographicPath.startsWith('file:///mnt/c/')) {
          iframeSrc = 'http://localhost:3005/' + currentInfographicPath.replace('file:///mnt/c/github/claudeplus/', '');
        }
        infographicFrame.src = iframeSrc + '?t=' + Date.now();
      }
    }

    // Open in external browser
    function openInBrowser() {
      if (currentInfographicPath) {
        console.log('[openInBrowser] Starting with currentInfographicPath:', currentInfographicPath);

        let filePath = currentInfographicPath;

        // Remove cache-busting query params
        filePath = filePath.split('?')[0];
        console.log('[openInBrowser] After removing query params:', filePath);

        // Convert WSL file:// path to Windows file:// path
        // Input: file:///mnt/c/github/claudeplus/proxy/...
        // Output: file:///C:/github/claudeplus/proxy/...
        if (filePath.startsWith('file:///mnt/c/')) {
          filePath = filePath.replace('file:///mnt/c/', 'file:///C:/');
          console.log('[openInBrowser] After WSL to Windows conversion:', filePath);
        } else {
          console.log('[openInBrowser] No conversion needed (does not start with file:///mnt/c/)');
        }

        console.log('[openInBrowser] Final path to open:', filePath);
        window.open(filePath, '_blank');
      } else {
        console.log('[openInBrowser] No currentInfographicPath set');
      }
    }

    // Auto-refresh toggle
    function toggleAutoRefresh(enabled) {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
      }

      if (enabled) {
        autoRefreshInterval = setInterval(() => {
          refreshInfographic();
          loadPipelines(); // Also refresh pipeline list
        }, 2000);
      }
    }

    // Event listeners
    pipelineSelect.addEventListener('change', (e) => {
      const pipelineId = e.target.value;
      if (pipelineId) {
        loadRuns(pipelineId);
      } else {
        runSelectWrapper.style.display = 'none';
        viewIndexBtn.style.display = 'none';
        displayInfographic('');
      }
    });

    runSelect.addEventListener('change', (e) => {
      const path = e.target.value;
      if (path) {
        displayInfographic(path);
      } else {
        // "Latest run" selected - load latest
        const pipelineId = pipelineSelect.value;
        const pipeline = pipelinesData.find(p => p.id === pipelineId);
        if (pipeline) {
          displayInfographic(pipeline.latestRunPath);
        }
      }
    });

    viewIndexBtn.addEventListener('click', () => {
      if (currentIndexPath) {
        displayInfographic(currentIndexPath);
      }
    });

    refreshBtn.addEventListener('click', () => {
      refreshInfographic();
      loadPipelines();
    });

    autoRefreshCheckbox.addEventListener('change', (e) => {
      toggleAutoRefresh(e.target.checked);
    });

    openInBrowserBtn.addEventListener('click', openInBrowser);

    // Initialize
    loadPipelines();
    toggleAutoRefresh(true); // Start with auto-refresh enabled
  </script>
</body>
</html>
