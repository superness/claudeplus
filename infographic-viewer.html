<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pipeline Infographic Viewer</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      height: 100vh;
      overflow: hidden;
    }
    .viewer-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    .header {
      background: white;
      padding: 20px 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 {
      font-size: 1.8em;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .view-toggle {
      display: flex;
      gap: 10px;
      margin-right: 20px;
    }
    .view-toggle button {
      padding: 8px 16px;
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
      font-size: 0.9em;
    }
    .view-toggle button.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .controls {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    .select-wrapper {
      position: relative;
    }
    select {
      padding: 10px 40px 10px 15px;
      border: 2px solid #667eea;
      border-radius: 8px;
      font-size: 1em;
      background: white;
      cursor: pointer;
      appearance: none;
      min-width: 300px;
    }
    .select-wrapper::after {
      content: '‚ñº';
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      color: #667eea;
    }
    button {
      padding: 10px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      cursor: pointer;
      font-weight: bold;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    button:active {
      transform: translateY(0);
    }
    .auto-refresh {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9em;
      color: #333;
    }
    .auto-refresh input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    .iframe-container {
      flex: 1;
      background: white;
      margin: 20px;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      overflow: hidden;
    }
    iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    .no-selection {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #999;
      font-size: 1.2em;
    }
    .no-selection svg {
      width: 150px;
      height: 150px;
      margin-bottom: 20px;
      opacity: 0.3;
    }
    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
    }
    .status-running { background: #ffc107; animation: pulse 1.5s infinite; }
    .status-completed { background: #28a745; }
    .status-error { background: #dc3545; }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Modern Progress Modal */
    .progress-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      animation: fadeIn 0.3s ease-out;
    }
    .progress-modal.active {
      display: flex;
    }
    .progress-content {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .progress-header {
      text-align: center;
      margin-bottom: 30px;
    }
    .progress-icon {
      font-size: 4em;
      margin-bottom: 15px;
      animation: float 3s ease-in-out infinite;
    }
    .progress-title {
      font-size: 1.5em;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
    }
    .progress-subtitle {
      font-size: 1em;
      color: #666;
    }
    .progress-bar-container {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 20px;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      width: 0%;
      transition: width 0.5s cubic-bezier(0.16, 1, 0.3, 1);
      box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
    }
    .progress-steps {
      margin-bottom: 20px;
    }
    .progress-step {
      display: flex;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #f0f0f0;
      opacity: 0.3;
      transition: all 0.3s ease;
    }
    .progress-step:last-child {
      border-bottom: none;
    }
    .progress-step.active {
      opacity: 1;
      transform: translateX(0);
    }
    .progress-step.completed {
      opacity: 0.6;
    }
    .step-icon {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      font-size: 1.2em;
      background: #e0e0e0;
      color: #999;
      transition: all 0.3s ease;
    }
    .progress-step.active .step-icon {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      animation: pulse-ring 2s infinite;
    }
    .progress-step.completed .step-icon {
      background: #28a745;
      color: white;
    }
    .step-text {
      flex: 1;
      font-size: 0.95em;
      color: #333;
    }
    .progress-status {
      text-align: center;
      padding: 20px;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
      border-radius: 12px;
      font-size: 0.9em;
      color: #667eea;
      font-weight: 500;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    @keyframes pulse-ring {
      0% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7); }
      50% { box-shadow: 0 0 0 10px rgba(102, 126, 234, 0); }
      100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0); }
    }
  </style>
</head>
<body>
  <div class="viewer-container">
    <div class="header">
      <h1>üìä Pipeline Infographic Viewer</h1>
      <div class="view-toggle">
        <button id="viewInfographic" class="active">üìä Infographic</button>
        <button id="viewStory">üìñ Story</button>
      </div>
      <div class="controls">
        <div class="select-wrapper">
          <select id="pipelineSelect">
            <option value="">Select a pipeline...</option>
          </select>
        </div>
        <div class="select-wrapper" id="runSelectWrapper" style="display: none;">
          <select id="runSelect">
            <option value="">Select a run...</option>
          </select>
        </div>
        <button id="viewIndexBtn" style="display: none;">üìã View All Runs</button>
        <button id="generateStoryBtn" style="display: none;">‚ú® Generate Story</button>
        <button id="refreshBtn">üîÑ Refresh</button>
        <div class="auto-refresh">
          <input type="checkbox" id="autoRefresh" checked>
          <label for="autoRefresh">Auto-refresh (2s)</label>
        </div>
        <button id="openInBrowser">üåê Open in Browser</button>
      </div>
    </div>
    <div class="iframe-container">
      <div id="noSelection" class="no-selection">
        <svg viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="100" cy="100" r="80" stroke="currentColor" stroke-width="4"/>
          <path d="M60 100 L90 130 L140 70" stroke="currentColor" stroke-width="8" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <div>Select a pipeline to view its infographic</div>
      </div>
      <iframe id="infographicFrame" style="display: none;"></iframe>
    </div>
  </div>

  <!-- Progress Modal -->
  <div id="progressModal" class="progress-modal">
    <div class="progress-content">
      <div class="progress-header">
        <div class="progress-icon">‚ú®</div>
        <div class="progress-title">Generating Story</div>
        <div class="progress-subtitle">Claude is crafting your magical report...</div>
      </div>

      <div class="progress-bar-container">
        <div id="progressBar" class="progress-bar"></div>
      </div>

      <div class="progress-steps">
        <div class="progress-step" data-step="0">
          <div class="step-icon">üìã</div>
          <div class="step-text">Analyzing pipeline execution data</div>
        </div>
        <div class="progress-step" data-step="1">
          <div class="step-icon">üé®</div>
          <div class="step-text">Designing creative layout</div>
        </div>
        <div class="progress-step" data-step="2">
          <div class="step-icon">‚úçÔ∏è</div>
          <div class="step-text">Writing narrative</div>
        </div>
        <div class="progress-step" data-step="3">
          <div class="step-icon">üé≠</div>
          <div class="step-text">Adding visual magic</div>
        </div>
        <div class="progress-step" data-step="4">
          <div class="step-icon">üíé</div>
          <div class="step-text">Polishing final report</div>
        </div>
      </div>

      <div id="progressStatus" class="progress-status">
        Preparing to generate story...
      </div>
    </div>
  </div>

  <script>
    const pipelineSelect = document.getElementById('pipelineSelect');
    const runSelect = document.getElementById('runSelect');
    const runSelectWrapper = document.getElementById('runSelectWrapper');
    const viewIndexBtn = document.getElementById('viewIndexBtn');
    const generateStoryBtn = document.getElementById('generateStoryBtn');
    const infographicFrame = document.getElementById('infographicFrame');
    const noSelection = document.getElementById('noSelection');
    const refreshBtn = document.getElementById('refreshBtn');
    const autoRefreshCheckbox = document.getElementById('autoRefresh');
    const openInBrowserBtn = document.getElementById('openInBrowser');
    const viewInfographicBtn = document.getElementById('viewInfographic');
    const viewStoryBtn = document.getElementById('viewStory');

    let autoRefreshInterval = null;
    let currentInfographicPath = null;
    let currentStoryPath = null;
    let currentIndexPath = null;
    let currentRunDirectory = null; // Track the run directory for story generation
    let currentPipelineId = null; // Track current pipeline ID
    let pipelinesData = [];
    let currentView = 'infographic'; // 'infographic' or 'story'

    // Load available pipelines
    async function loadPipelines() {
      try {
        const response = await fetch('http://localhost:8081/list-infographics');
        const data = await response.json();

        pipelinesData = data.infographics;
        pipelineSelect.innerHTML = '<option value="">Select a pipeline...</option>';

        data.infographics.forEach(infographic => {
          const option = document.createElement('option');
          option.value = infographic.id;
          option.textContent = `${infographic.name} (${infographic.totalRuns} runs, ${infographic.status})`;
          option.dataset.status = infographic.status;
          pipelineSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading pipelines:', error);
      }
    }

    // Load runs for selected pipeline
    function loadRuns(pipelineId) {
      const pipeline = pipelinesData.find(p => p.id === pipelineId);
      if (!pipeline) return;

      currentPipelineId = pipelineId; // Track current pipeline
      runSelect.innerHTML = '<option value="">Latest run</option>';
      currentIndexPath = pipeline.indexPath;

      pipeline.runs.forEach((run, index) => {
        const option = document.createElement('option');
        option.value = run.path;
        const date = new Date(run.modified);

        // Check if this run has a story
        const hasStory = run.path.includes('/run_');
        const storyIndicator = hasStory ? ' üìñ' : '';

        option.textContent = `Run ${pipeline.runs.length - index}: ${run.timestamp.replace('T', ' ')}${storyIndicator}`;
        option.dataset.hasStory = hasStory;
        runSelect.appendChild(option);
      });

      // Show run selector and index button
      runSelectWrapper.style.display = 'block';
      viewIndexBtn.style.display = pipeline.indexPath ? 'block' : 'none';

      // Auto-select latest run
      displayContent(pipeline.latestRunPath);
    }

    // Display selected content (infographic or story)
    function displayContent(path) {
      console.log('[displayContent] Called with path:', path, 'view:', currentView);

      if (!path) {
        infographicFrame.style.display = 'none';
        noSelection.style.display = 'flex';
        currentInfographicPath = null;
        currentStoryPath = null;
        currentRunDirectory = null;
        generateStoryBtn.style.display = 'none';
        return;
      }

      // Determine story path from infographic path
      let infographicPath = path;
      let storyPath = null;
      let runDirectory = null;

      if (path.includes('/run_')) {
        // This is a run directory - construct story path
        const runDir = path.substring(0, path.lastIndexOf('/'));
        storyPath = runDir + '/story.html';
        infographicPath = runDir + '/infographic.html';

        // Extract WSL path for API call
        runDirectory = runDir.replace('file://', '');

        console.log('[displayContent] Run detected. Story path:', storyPath);
        console.log('[displayContent] Run directory:', runDirectory);
      }

      currentInfographicPath = infographicPath;
      currentStoryPath = storyPath;
      currentRunDirectory = runDirectory;

      // Decide which to display based on current view
      let displayPath = (currentView === 'story' && storyPath) ? storyPath : infographicPath;

      // Convert file:// paths to localhost URLs for iframe
      let iframeSrc = displayPath;
      if (displayPath.startsWith('file:///mnt/c/')) {
        iframeSrc = 'http://localhost:3005/' + displayPath.replace('file:///mnt/c/github/claudeplus/', '');
        console.log('[displayContent] Converted file:// to localhost:', iframeSrc);
      }

      infographicFrame.src = iframeSrc + '?t=' + Date.now(); // Cache bust
      console.log('[displayContent] Set iframe src to:', infographicFrame.src);
      infographicFrame.style.display = 'block';
      noSelection.style.display = 'none';

      // Show "Generate Story" button if we have a run directory
      generateStoryBtn.style.display = currentRunDirectory ? 'block' : 'none';

      // Update view toggle state
      updateViewToggle();
    }

    // Update view toggle buttons
    function updateViewToggle() {
      if (currentView === 'story' && currentStoryPath) {
        viewStoryBtn.classList.add('active');
        viewInfographicBtn.classList.remove('active');
      } else {
        viewInfographicBtn.classList.add('active');
        viewStoryBtn.classList.remove('active');
      }

      // Disable story button if no story available
      viewStoryBtn.disabled = !currentStoryPath;
      if (!currentStoryPath) {
        viewStoryBtn.style.opacity = '0.5';
        viewStoryBtn.style.cursor = 'not-allowed';
      } else {
        viewStoryBtn.style.opacity = '1';
        viewStoryBtn.style.cursor = 'pointer';
      }
    }

    // Refresh current content
    function refreshContent() {
      const displayPath = (currentView === 'story' && currentStoryPath) ? currentStoryPath : currentInfographicPath;
      if (displayPath) {
        let iframeSrc = displayPath;
        if (displayPath.startsWith('file:///mnt/c/')) {
          iframeSrc = 'http://localhost:3005/' + displayPath.replace('file:///mnt/c/github/claudeplus/', '');
        }
        infographicFrame.src = iframeSrc + '?t=' + Date.now();
      }
    }

    // Open in external browser
    function openInBrowser() {
      const displayPath = (currentView === 'story' && currentStoryPath) ? currentStoryPath : currentInfographicPath;
      if (displayPath) {
        console.log('[openInBrowser] Starting with path:', displayPath);

        let filePath = displayPath;

        // Remove cache-busting query params
        filePath = filePath.split('?')[0];
        console.log('[openInBrowser] After removing query params:', filePath);

        // Convert WSL file:// path to Windows file:// path
        // Input: file:///mnt/c/github/claudeplus/proxy/...
        // Output: file:///C:/github/claudeplus/proxy/...
        if (filePath.startsWith('file:///mnt/c/')) {
          filePath = filePath.replace('file:///mnt/c/', 'file:///C:/');
          console.log('[openInBrowser] After WSL to Windows conversion:', filePath);
        } else {
          console.log('[openInBrowser] No conversion needed (does not start with file:///mnt/c/)');
        }

        console.log('[openInBrowser] Final path to open:', filePath);
        window.open(filePath, '_blank');
      } else {
        console.log('[openInBrowser] No path set');
      }
    }

    // Auto-refresh toggle
    function toggleAutoRefresh(enabled) {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
      }

      if (enabled) {
        autoRefreshInterval = setInterval(() => {
          refreshContent();
          loadPipelines(); // Also refresh pipeline list
        }, 2000);
      }
    }

    // Event listeners
    pipelineSelect.addEventListener('change', (e) => {
      const pipelineId = e.target.value;
      if (pipelineId) {
        loadRuns(pipelineId);
      } else {
        runSelectWrapper.style.display = 'none';
        viewIndexBtn.style.display = 'none';
        displayContent('');
      }
    });

    runSelect.addEventListener('change', (e) => {
      const path = e.target.value;
      if (path) {
        displayContent(path);
      } else {
        // "Latest run" selected - load latest
        const pipelineId = pipelineSelect.value;
        const pipeline = pipelinesData.find(p => p.id === pipelineId);
        if (pipeline) {
          displayContent(pipeline.latestRunPath);
        }
      }
    });

    viewIndexBtn.addEventListener('click', () => {
      if (currentIndexPath) {
        displayContent(currentIndexPath);
      }
    });

    viewInfographicBtn.addEventListener('click', () => {
      if (currentView !== 'infographic') {
        currentView = 'infographic';
        displayContent(currentInfographicPath);
      }
    });

    viewStoryBtn.addEventListener('click', () => {
      if (currentView !== 'story' && currentStoryPath) {
        currentView = 'story';
        displayContent(currentStoryPath);
      }
    });

    refreshBtn.addEventListener('click', () => {
      refreshContent();
      loadPipelines();
    });

    autoRefreshCheckbox.addEventListener('change', (e) => {
      toggleAutoRefresh(e.target.checked);
    });

    openInBrowserBtn.addEventListener('click', openInBrowser);

    // Progress modal controller
    const progressModal = {
      element: document.getElementById('progressModal'),
      bar: document.getElementById('progressBar'),
      status: document.getElementById('progressStatus'),
      currentStep: 0,
      totalSteps: 5,

      show() {
        this.element.classList.add('active');
        this.reset();
        this.startProgress();
      },

      hide() {
        this.element.classList.remove('active');
        this.stopProgress();
      },

      reset() {
        this.currentStep = 0;
        this.bar.style.width = '0%';
        document.querySelectorAll('.progress-step').forEach(step => {
          step.classList.remove('active', 'completed');
        });
      },

      setProgress(percent, statusText) {
        this.bar.style.width = percent + '%';
        this.status.textContent = statusText;
      },

      activateStep(stepIndex) {
        const steps = document.querySelectorAll('.progress-step');

        // Mark previous steps as completed
        for (let i = 0; i < stepIndex; i++) {
          steps[i].classList.remove('active');
          steps[i].classList.add('completed');
        }

        // Mark current step as active
        if (steps[stepIndex]) {
          steps[stepIndex].classList.add('active');
        }

        this.currentStep = stepIndex;
      },

      startProgress() {
        this.progressInterval = setInterval(() => {
          // Simulate progress through steps over ~30 seconds
          const totalDuration = 30000; // 30 seconds
          const stepDuration = totalDuration / this.totalSteps;
          const currentTime = this.currentStep * stepDuration;
          const progressPercent = Math.min((currentTime / totalDuration) * 100, 95);

          this.setProgress(progressPercent, this.getStepMessage(this.currentStep));
          this.activateStep(this.currentStep);

          // Move to next step every 6 seconds
          if (this.currentStep < this.totalSteps - 1) {
            this.currentStep++;
          }
        }, 6000);

        // Initial step
        this.activateStep(0);
        this.setProgress(5, this.getStepMessage(0));
      },

      stopProgress() {
        if (this.progressInterval) {
          clearInterval(this.progressInterval);
          this.progressInterval = null;
        }
      },

      complete() {
        this.setProgress(100, '‚úÖ Story generated successfully!');
        this.activateStep(this.totalSteps);

        // Mark all steps as completed
        document.querySelectorAll('.progress-step').forEach(step => {
          step.classList.remove('active');
          step.classList.add('completed');
        });

        setTimeout(() => {
          this.hide();
          location.reload();
        }, 2000);
      },

      error(message) {
        this.stopProgress();
        this.status.textContent = '‚ùå ' + message;
        this.status.style.background = 'linear-gradient(135deg, rgba(220, 53, 69, 0.1) 0%, rgba(220, 53, 69, 0.2) 100%)';
        this.status.style.color = '#dc3545';

        setTimeout(() => {
          this.hide();
        }, 3000);
      },

      getStepMessage(step) {
        const messages = [
          'Reading pipeline execution logs...',
          'Brainstorming creative presentation ideas...',
          'Crafting engaging narrative from technical data...',
          'Designing beautiful visualizations and animations...',
          'Adding final touches and polish...'
        ];
        return messages[step] || 'Processing...';
      }
    };

    // Generate story on demand - calls local infographic-server.js
    generateStoryBtn.addEventListener('click', async () => {
      if (!currentRunDirectory) {
        alert('No run selected');
        return;
      }

      // Extract pipeline ID from run directory path
      // Example: /mnt/c/github/claudeplus/proxy/pipeline-infographics/pipeline_1763481643642/run_1763481643803
      const pipelineIdMatch = currentRunDirectory.match(/pipeline_(\d+)/);
      const pipelineId = pipelineIdMatch ? `pipeline_${pipelineIdMatch[1]}` : null;

      if (!pipelineId) {
        alert('Could not extract pipeline ID from run directory');
        return;
      }

      // Disable button and show progress modal
      generateStoryBtn.disabled = true;
      generateStoryBtn.textContent = '‚è≥ Generating...';
      progressModal.show();

      try {
        const response = await fetch('http://localhost:3005/api/generate-story', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ pipelineId })
        });

        const result = await response.json();

        if (response.ok) {
          // Success! Complete the progress animation
          progressModal.complete();
        } else {
          progressModal.error(result.error || 'Story generation failed');
        }
      } catch (error) {
        console.error('Error generating story:', error);
        progressModal.error(error.message);
      } finally {
        // Re-enable button
        generateStoryBtn.disabled = false;
        generateStoryBtn.textContent = '‚ú® Generate Story';
      }
    });

    // Initialize
    loadPipelines();
    toggleAutoRefresh(true); // Start with auto-refresh enabled
  </script>
</body>
</html>
